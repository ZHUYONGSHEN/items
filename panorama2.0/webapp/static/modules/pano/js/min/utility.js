/*
 * Created by shiyong on 5/1/16.
 */
function getCookie(e){var t=new RegExp(e+"=([^;]+)"),n=t.exec(document.cookie);return null!=n?unescape(n[1]):null}function setCookie(e,t){document.cookie=""+e+"="+t+";"}function getJsonFromUrl(){var e=location.search.substr(1),t={};return e.split("&").forEach(function(e){var n=e.split("=");t[n[0]]=decodeURIComponent(n[1])}),t}function checkAuth(e){var t=null!=getCookie("USERID")&&null!=getCookie("SESSION")&&null!=getCookie("EXPIRETIME");if(t&&(t=Number(getCookie("EXPIRETIME"))>Date.now()/1e3),!t&&e){var n=window.location.hostname;"http://"+n+"/login/index.html?from="+window.location;window.open("http://app.hiweixiao.com/Proxy/Public/login?token_msg=123","_self")}return t}function collectUnKnowRes(e,t,n){var i,r;if(e instanceof Array)for(i in e)collectUnKnowRes(e[i],t,n);else if("object"==typeof e)for(i in e)r=e[i],i.endWith("res_id")&&void 0===n[r]?t.push(r):collectUnKnowRes(r,t,n)}function validResMap(e,t){for(var n in e){var i=e[n].oorigin_id;void 0===t[i]&&(t[i]=[]),t[i].push(e[n])}}function fileMd5(e,t){var n=new FileReader;n.onload=function(n){if(e.size!=n.target.result.length)isError=!0;else{var i=SparkMD5.hashBinary(n.target.result);e.md5=i,$.isFunction(t)&&t(i)}},n.onerror=function(){},n.readAsBinaryString(e)}function spinnerOpts(){var e={lines:13,length:20,width:7,radius:30,scale:.5,corners:1,color:"#000",opacity:.25,rotate:17,direction:1,speed:1.1,trail:42,fps:20,zIndex:2e9,className:"spinner",shadow:!1,hwaccel:!1};return Object.create(e)}function createUploadFileObj(e,t,n,i,r){var o=new Resumable({target:"/file/upload",chunkSize:1048576,simultaneousUploads:4,testChunks:!1,throttleProgressCallbacks:1,generateUniqueIdentifier:function(e){return e.md5Identifier},query:{resumableIsPanorama:i|!1}});if(n){o.circleWidget=$('<div><strong style="position: absolute;top: 0px;left: 0;width: 100%;text-align: center;line-height: 80px;font-size: 20px;">0.0<i>%</i></strong></div>'),o.circleWidget.circleProgress({value:0,size:80,animation:{duration:100}}),o.circleWidget.digit=function(e){o.circleWidget.find("strong").html((100*e).toFixed(1)+"<i>%</i>"),console.log("set progress vlalue",e)};var a=(n.width()-80)/2,c=(n.height()-80)/2;o.circleWidget.css("position","absolute").css("left",a+"px").css("top",c+"px").appendTo(n)}if(o.support)return o.on("fileAdded",function(e){if(t.trigger(),o.circleWidget){var n=o.circleWidget.circleProgress("value")+.02;n=n<.1?n:.1,o.circleWidget.circleProgress("value",n),o.circleWidget.digit(n)}console.log("fileAdded",e.fileName)}),o.on("pause",function(){}),o.on("complete",function(){o.circleWidget&&o.circleWidget.remove(),console.log("file complete","xxx"),e()}),o.on("fileSuccess",function(e,t){console.log("fileSuccess",e.fileName)}),o.on("fileError",function(e,t){o.circleWidget&&o.circleWidget.remove()}),o.on("fileProgress",function(e){if(o.circleWidget){var t=o.progress(!0);t=.1+.88*t,o.circleWidget.circleProgress("value",t),o.circleWidget.digit(t)}}),o.on("cancel",function(){o.circleWidget&&o.circleWidget.remove(),r()}),o.on("uploadStart",function(){o.circleWidget&&(o.circleWidget.circleProgress("value",.1),o.circleWidget.digit(.1))}),o}function addSandTablePoint(e,t){var n=$("#sand-table-pic"),i=t.percentx*n.outerWidth(!0)+n.position().left,r=t.percenty*n.outerHeight(!0)+n.position().top,o=$("<div></div>").addClass("sand-table-arrow").data("idx",t.scene_id).css("position","absolute").css("left",i).css("top",r).css("transform","rotate("+t.angle+"deg)").appendTo(e);return o}function initSandTablePoints(e,t){for(var n=t.points,i=0;i<n.length;++i)addSandTablePoint(e,n[i])}function sandPointView(e){var t=void 0;return $(".sand-table-view .sand-table-arrow").each(function(n,i){if(e===$(i).data("idx"))return t=$(i),!1}),t}function initVisualAngle(e){0===e.max_fov&&0===e.min_fov&&0===e.max_angle&&0===e.init_fov?(e.max_fov=cameraMaxFov,e.min_fov=cameraMinFov,e.max_angle=89.9,e.min_angle=-89.9,e.init_fov=90,e.init_point={x:0,y:0,z:500}):e.max_angle>=90?e.max_angle=89.99:e.min_angle<=-90&&(e.min_angle=-89.99)}function getPicfileSize(e){var t=/\.(original|[0-9]+)\.(original|[0-9]+)\.[^\.]+$/,n=t.exec(e.id);if(null===n)return{width:0,height:0};var i=isNaN(parseInt(n[1]))?n[1]:parseInt(n[1]),r=isNaN(parseInt(n[2]))?n[2]:parseInt(n[1]);return{width:i,height:r}}function cmpPictureSize(e,t){return"original"==e.width?1:"original"==t.width?-1:e.width==t.width?e.height-t.height:e.width-t.width}function gainCanvasBlob(e,t){function n(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(t.length),r=new Uint8Array(i),o=0;o<t.length;o++)r[o]=t.charCodeAt(o);var a=new Blob([i],{type:n});return a}f=navigator.userAgent.search("Firefox"),f>-1?e.toBlob(t,"image/jpeg"):(blob=n(e.toDataURL("image/jpeg")),t(blob))}function getBlobMd5(e,t){if(!t)return void e.resolve();var n=new FileReader;n.onload=function(n){var i=SparkMD5.hashBinary(n.target.result);e.resolve(t,i)},n.readAsDataURL(t)}function uploadBlob(e,t,n,i){function r(){e.resolve(n)}if(!t)return void e.resolve();var o,a=navigator.userAgent.search("Firefox");o=a>-1?new File([t],i,{type:"image/jpeg"}):t,o.md5=n;var c={trigger:function(){l.upload()}},l=createUploadFileObj(r,c);o.md5Identifier=n+".jpg",l.addFile(o)}function detectInfo(){var e=window.detect.parse(navigator.userAgent),t=__support_device_info[e.device.name];return t||(t={screen:5.5}),void 0===t.screen&&(t.screen=5.5),void 0===e.device.name&&(e.device.name="Unknown"),e.device.screen=t.screen,e}function countUserAction(e,t,n){function i(e){var t=e.toISOString();t.replace("T"," "),t=t.replace("T"," "),t=t.replace("Z","");var n=t.indexOf(".");return t=t.substring(0,n)}$.get("http://ipinfo.io",function(e){var r=detectInfo(),o="productId=1&objectId=1&fromUrl="+window.location.href+(n?"&toUrl="+n:"")+"&fromUrlTime="+i(__start)+(n?"&toUrlTime="+i(new Date):"")+"&action="+t+"&userIp="+e.ip+"&browser="+r.browser.name,a=("Mobile"!==r.device.type,"http://hongbao.szzunhao.com/dct/datacount/InsertDataCountForPC.sys");$.ajax({type:"GET",url:a,data:o,dataType:"jsonp",jsonp:"callbackparam",success:function(){console.log("数据成功写入")},error:function(){console.log("页面加载失败！")}})},"jsonp")}function getFileList(e,t){var n={};e&&(n.category=e);var i=[];return $.ajax({type:"post",data:JSON.stringify(n),url:"/api/filelist",success:function(e){i=e.data||[]},async:!1}),i}function updateIdsFileToResourceMgr(e){0!==e.length&&$.ajax({type:"post",data:JSON.stringify(e),url:"/api/getFiles",success:function(e){var t={};validResMap(e.data,t),ResourceMgr.update(t)},async:!1})}function validFileInfoResource(e,t,n){var i=[];n=Math.min(e.length-t);for(var r=0;r<n;r++)if(""!==e[t+r].oorigin_id){var o=ResourceMgr.find(e[t+r].oorigin_id);o||i.push(e[t+r].oorigin_id)}updateIdsFileToResourceMgr(i)}function updateResourceFromIds(e){for(var t=[],n=0;n<e.length;n++){var i=ResourceMgr.find(e[n]);i||t.push(e[n])}updateIdsFileToResourceMgr(t)}function addfileinfo(e){var t=null;return $.ajax({type:"POST",data:JSON.stringify(e),url:"/api/addFileinfo",success:function(e){console.log(e),0===e.err_code&&(t=e.data)},async:!1}),t}function getFileItemPageSize(e,t){var n=!1;$(e).is(":hidden")&&($(e).show(),n=!0);var i=$(htmlFileItemStr);i.appendTo($(e));var r=i.width();i.remove();var o=Math.floor($(e).width()/r)*t;return n&&$(e).hide(),o}function refreshFileListItem(e,t,n,i){validFileInfoResource(t,n,i),$(e).empty();for(var r=[],i=Math.min(t.length-n,i),o=0;o<i;o++){var a=$(htmlFileItemStr),c=($("input:first",a),$("img:first",a)),l=$(".file-name",a),s=ResourceMgr.find(t[n+o].oorigin_id),u="";s&&s.length>0&&(file=s[0],0==file.file_type.indexOf("image")?u=file.access_url:0==file.file_type.indexOf("audio")&&(u="/img/audio.jpg"),l.text(file.name),l.attr("title",file.name)),c.attr("src",u),a[0].dataSrc=t[n+o],a.appendTo($(e)),r.push(a[0])}return r}function filter(e,t){for(var n=[],i=0;i<e.length;i++)t(e[i])&&n.push(e[i]);return n}function initFileListPane(e,t,n,i){function r(e){function t(e){var t="";return e.tags&&e.tags.length>0&&(t=e.tags[0]),void 0===n[e.oorigin_id+t]&&(n[e.oorigin_id+t]=!0,!0)}var n={};return filter(e,t)}function o(t){var n=[];return n=0!=v.length&&0==v[0].checked?[].concat(e.filelist):r(e.filelist)}function a(t){for(var n=t.dataSrc,i=0;i<e.selected.length&&n!=e.selected[i];i++);i<e.selected.length&&$(t).addClass("selected")}var c=$(".preview",e),l=$(".page",e),s=$(".cur-page",e),u=$(".next",e),d=$(".pane",e),g=$(".jump-page",e),f=$(".jump-btn",e),p=getFileItemPageSize(e,n),v=$(".is-show-unique",e);v[0]&&(v[0].checked=!0),e.index=0,e.selected=[],e.filelist=t;var h=o(t),_=function(t){return function(n){if(t!=n.target){var r=t.dataSrc;$(t).hasClass("selected")?($(t).removeClass("selected"),e.selected.splice(jQuery.inArray(r,e.selected),1)):($(t).addClass("selected"),e.selected.push(r)),i&&i(t)}}};e.update=function(t){if(t&&(h=o(e.filelist)),!h||0==h.length)return l.hide(),d.empty(),void $("<p>没有对应资源</p>").appendTo(d);l.show();var n=Math.max(1,Math.ceil(h.length/p));items=refreshFileListItem(d[0],h,e.index*p,p),$.each(items,function(){$(this).click(_(this)),a(this)}),s.text(""+(e.index+1)+"/"+n)},c.unbind("click"),c.click(function(){0!=e.index&&(e.index--,e.update())}),u.unbind("click"),u.click(function(){var t=Math.max(1,Math.ceil(h.length/p));e.index+1!=t&&(e.index++,e.update())}),g.length>0&&(f.unbind("click"),f.click(function(){if(Number(g.val())==parseInt(g.val())){var t=parseInt(g.val())-1,n=Math.max(1,Math.ceil(h.length/p)),i=Math.min(n-1,t);i=Math.max(0,i),t==i&&(g.val(""),i!=e.index&&(e.index=i,e.update()))}})),v.length>0&&(v.unbind("change"),v.change(function(){initFileListPane(e,t,n,i)})),e.update()}function filterFile(e,t){var n=[];if(t){validFileInfoResource(e,0,e.length);for(var i=0;i<e.length;i++)if(""!=e.oorigin_id){var r=ResourceMgr.find(e[i].oorigin_id);r&&0!=r.length&&0==r[0].file_type.indexOf(t)&&n.push(e[i])}}else n=n.concat(e);return n}function sceneIdxById(e,t){for(var n=0;n<t.length;n++)if(e==t[n].id)return n;return-1}function sceneImageView(e){var t=e.thumbnail_res_id;""==t&&(t=e.res_id);var n=$('<div class="img-cls">                       <img crossorigin ="Anonymous"/>                      <div class="file-name"></div>                     </div> ').data("_id",e.id),i=ResourceMgr.find(t);return $("img",n).attr("src",i&&i.length>0?i[0].access_url:""),$(".file-name",n).text(e.name),n}function enterFullscreen(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function horizontalRotateAngle(){if(Math.abs(accelerationIncludingGravity.z)>5*(Math.abs(accelerationIncludingGravity.x)+Math.abs(accelerationIncludingGravity.y)))return 0;var e=0,t=window.orientation||0,n=t%180==0;return n&&0!==accelerationIncludingGravity.y?e=Math.atan(accelerationIncludingGravity.x/accelerationIncludingGravity.y):n||0===accelerationIncludingGravity.x||(e=-Math.atan(accelerationIncludingGravity.y/accelerationIncludingGravity.x)),180*e/Math.PI}function validPointtitle(e){return textLenght(e)<=20}function textLenght(e){for(var t=0,n=0;n<e.length;n++){var i=e.charCodeAt(n);i>=1&&i<=126||65376<=i&&i<=65439?t++:t+=1.6}return t}String.prototype.format||(String.prototype.format=function(){var e=arguments[0];return this.replace(/{(\w+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})}),String.prototype.endWith||(String.prototype.endWith=function(e){return!(null===e||""===e||0===this.length||e.length>this.length)&&this.substring(this.length-e.length)==e});var SLCUtility={},__support_device_info={"MI NOTE LTE":{screen:5.7}};SLCUtility.browser={versions:function(){var e=navigator.userAgent;navigator.appVersion;return{trident:e.indexOf("Trident")>-1,presto:e.indexOf("Presto")>-1,webKit:e.indexOf("AppleWebKit")>-1,gecko:e.indexOf("Gecko")>-1&&e.indexOf("KHTML")==-1,mobile:!!e.match(/AppleWebKit.*Mobile.*/),ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:e.indexOf("Android")>-1||e.indexOf("Linux")>-1,iPhone:e.indexOf("iPhone")>-1,iPad:e.indexOf("iPad")>-1,webApp:e.indexOf("Safari")==-1}}(),language:(navigator.browserLanguage||navigator.language).toLowerCase()},SLCUtility.getHtmlId=function(){var e=1;return function(){return e+=1,e.toString()}}(),SLCUtility.getParentIdByClassId=function(e,t){var n=e||window.event,i=n.srcElement||n.target;$(i).hasClass(t)===!1&&(i=$(i).parent("."+t));var r=$(i).attr("id");return r?r:null},SLCUtility.getClientPoint=function(){return"BackCompat"===document.compatMode?{width:document.body.clientWidth,height:document.body.clientHeight}:{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}},SLCUtility.getHttpObj=function(){var e=null;if(window.ActiveXObject)try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=null}}return null===e&&window.XMLHttpRequest&&(e=new XMLHttpRequest),e},SLCUtility.getResoultJsonObj=function(jsonTest){var jsonObj=null;try{jsonObj=eval("("+jsonTest+")");var a=0;a=1}catch(e){return null}return jsonObj},SLCUtility.callFunc=function(e,t,n){var i=SLCUtility.getHttpObj(),r=null;i.onreadystatechange=function(){4==i.readyState&&(r=SLCUtility.getResoultJsonObj(i.responseText))};var o=window.location.host;i.open(e,"http://"+o+"/api/"+t,!1);var a=JSON.stringify(n);return i.send(a),r},function(){var e=function(e){var t,n;return t=function(t,n){var i;return i=e.getShaderPrecisionFormat(t,n),{rangeMin:i.rangeMin,rangeMax:i.rangeMax,precision:i.precision}},n=function(n){return{LOW_FLOAT:t(n,e.LOW_FLOAT),MEDIUM_FLOAT:t(n,e.MEDIUM_FLOAT),HIGH_FLOAT:t(n,e.HIGH_FLOAT),LOW_INT:t(n,e.LOW_INT),MEDIUM_INT:t(n,e.MEDIUM_INT),HIGH_INT:t(n,e.HIGH_INT)}},{VERTEX_SHADER:n(e.VERTEX_SHADER),FRAGMENT_SHADER:n(e.FRAGMENT_SHADER)}},t=function(e,t){var n,i,r,o,a,c,l;for(a={},c=0,l=t.length;c<l;c++)i=t[c],n=e[i],null!=n&&(r=e.getParameter(n),r instanceof Float32Array||r instanceof Int32Array?a[i]=function(){var e,t,n;for(n=[],e=0,t=r.length;e<t;e++)o=r[e],n.push(o);return n}():a[i]=r);return a},n=function(e){var t,n,i,r,o,a;for(r=e.getSupportedExtensions(),t={},o=0,a=r.length;o<a;o++)i=r[o],i.match("texture_filter_anisotropic")?(n=e.getExtension(i),t[i]={MAX_TEXTURE_MAX_ANISOTROPY_EXT:e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}):i.match("OES_standard_derivatives")?(n=e.getExtension(i),t[i]={FRAGMENT_SHADER_DERIVATIVE_HINT_OES:e.getParameter(n.FRAGMENT_SHADER_DERIVATIVE_HINT_OES)}):i.match("WEBGL_draw_buffers")?(n=e.getExtension(i),t[i]={MAX_COLOR_ATTACHMENTS_WEBGL:e.getParameter(n.MAX_COLOR_ATTACHMENTS_WEBGL),MAX_DRAW_BUFFERS_WEBGL:e.getParameter(n.MAX_DRAW_BUFFERS_WEBGL)}):i.match("WEBGL_debug_renderer_info")&&(n=e.getExtension(i),null!=n&&(t[i]={UNMASKED_VENDOR_WEBGL:e.getParameter(n.UNMASKED_VENDOR_WEBGL),UNMASKED_RENDERER_WEBGL:e.getParameter(n.UNMASKED_RENDERER_WEBGL)}));return{supported:r,capabilities:t}},i=function(e,t,n){var i;try{return i=t.getContext(n,{stencil:!0}),null!=i&&(e.name=n,e.supported=!0),i}catch(e){return null}},r=function(e,t,n){var r;return r=i(e,t,n),null==r&&(r=i(e,t,"experimental-"+n)),r},o=function(i,o){var a,c,l;return a=document.createElement("canvas"),l={supported:!1},null!=a&&null!=a.getContext&&(c=r(l,a,i),null!=c&&(c.enable(c.SAMPLE_ALPHA_TO_COVERAGE),c.enable(c.SAMPLE_COVERAGE),l.params=t(c,o),l.extensions=n(c),null!=c.getShaderPrecisionFormat?l.shaderPrecision=e(c):l.shaderPrecision=null)),l},a="ALIASED_LINE_WIDTH_RANGE\nALIASED_POINT_SIZE_RANGE\nALPHA_BITS\nBLUE_BITS\nDEPTH_BITS\nGREEN_BITS\nMAX_COMBINED_TEXTURE_IMAGE_UNITS\nMAX_CUBE_MAP_TEXTURE_SIZE\nMAX_FRAGMENT_UNIFORM_VECTORS\nMAX_RENDERBUFFER_SIZE\nMAX_TEXTURE_IMAGE_UNITS\nMAX_TEXTURE_SIZE\nMAX_VARYING_VECTORS\nMAX_VERTEX_ATTRIBS\nMAX_VERTEX_TEXTURE_IMAGE_UNITS\nMAX_VERTEX_UNIFORM_VECTORS\nMAX_VIEWPORT_DIMS\nRED_BITS\nSAMPLE_COVERAGE_VALUE\nSAMPLES\nSTENCIL_BITS\nSUBPIXEL_BITS\nVENDOR\nRENDERER\nVERSION\nSHADING_LANGUAGE_VERSION\nCOMPRESSED_TEXTURE_FORMATS\nSAMPLE_BUFFERS".split("\n");SLCUtility.webgl=o("webgl",a);var c=detectInfo();c&&c.device&&c.os&&"iPhone"===c.device.name&&"iOS"===c.os.family&&8===c.os.major&&(SLCUtility.webgl.params.MAX_TEXTURE_SIZE/=2)}.call(this);var cameraMaxFov=90,cameraMinFov=40,ResourceMgr={resources:{},poleLogo:{},update:function(e){function t(e,t){return cmpPictureSize(getPicfileSize(e),getPicfileSize(t))}function n(e,n){for(var i=RegExp("bottom.jpg$"),r=RegExp("top.jpg$"),o=[],a=[],c=0;c<n.length;c++)i.test(n[c].id)||r.test(n[c].id)?o.push(n[c]):a.push(n[c]);a.length>0&&(a.sort(t),ResourceMgr.resources[e]=a),o.length>0&&(ResourceMgr.poleLogo[e]=o)}for(var i in e){var r=e[i];r&&r.length>0&&(r[0].file_type.indexOf("image")>=0?n(i,r):ResourceMgr.resources[i]=r)}},getResUrlList:function(e){var t=ResourceMgr.resources[e],n=new Array(t.length);t.sort(cmpPictureSize);for(var i=0;i<t.length;i++)n[i]=t[i].access_url;return n},decodeRes:function(e){var t=ResourceMgr.resources[e];return t&&0!==t.length?t[0].thumbnailUrl:null},decodePic:function(e,t){var n=ResourceMgr.resources[e];if(!n||0===n.length)return null;if(void 0===t)return n[n.length-1];var i=0;for(i;i<n.length&&!(cmpPictureSize(getPicfileSize(n[i]),t)>0);i++);return i=Math.max(0,i-1),n[i].access_url},getPoleLogo:function(e,t,n){var i=ResourceMgr.poleLogo[e];if(!i||0==i.length)return null;for(var r=t+"."+n+".jpg",o=0;o<i.length;o++)if(i[o].access_url==r)return i[o].access_url;return null},find:function(e){return ResourceMgr.resources[e]}},__start=new Date,htmlFileItemStr='<div style="float:left;">                <div class="img-cls">                   <img crossorigin ="Anonymous"/>                  <div class="file-name"></div>             </div>              <div style="clear:left;">               </div>             </div>',accelerationIncludingGravity={x:0,y:-1,z:0};window.addEventListener("devicemotion",function(e){accelerationIncludingGravity=e.accelerationIncludingGravity});