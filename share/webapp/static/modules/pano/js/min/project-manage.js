function jumpUrlAnchor(){var e=window.location.hash;if("#material"==e)return void onMaterialEditClick();if(0!==e.indexOf("#project="))if(0!==e.indexOf("#editscene="))$("#project-list-page").show();else for(var t=e.substring("#editscene=".length),a=0;a<SLCProjManage.projs.length;a++)SLCProjManage.projs[a].id==t&&(editProject(SLCProjManage.projs[a]),$('.nav-tabs a[href="#prj-edit-scene-tab"]').tab("show"));else for(var t=e.substring("#project=".length),a=0;a<SLCProjManage.projs.length;a++)SLCProjManage.projs[a].id==t&&editProject(SLCProjManage.projs[a])}function getProjectUrl(e){var t=location.protocol+"//"+location.hostname;""!=location.port&&80!=location.port&&(t+=":"+location.port);var a=t+"/pano/"+e.id;return a}function dateFromSecond(e){var t=new Date;return t.setTime(1e3*e),t}function projectTblAddRows(e){for(var t=$("#project-tbl-id").DataTable(),a=e.length-1;a>=0;a--){var n=e[a],i=dateFromSecond(n.create_time).toLocaleString(),r=getProjectUrl(n),o=$('<tr><td></td><td><div class="prj-tbl-url-div"><a target="_blank" class="prj-tbl-url-a text-center-hiddin-more" href="'+r+'">'+r+'</a><button class=\'btn btn-default copy-btn\'>复制</button></div></td><td class="text-center-hiddin-more"><p class="project-title text-center-hiddin-more">'+n.title+'</p></td><td class="text-center-hiddin-more"><p class="text-center-hiddin-more project-desc">'+n.desc+"</p></td><td>"+i+"</td><td>"+n.like+'</td><td class="tbl-operation-d-cls">             <span onclick="onEditProject(event)">编辑</span>             <span onclick="onDeleteProject(event)">删除</span>             </td></tr>');o.data("id",n.id),o.find(".copy-btn").click(function(){var e=$(this).siblings("a").attr("href"),t=$("<input>");$("body").append(t),t.val(e).select(),document.execCommand("copy"),t.remove()}),t.rows.add(o)}t.draw(!1)}function getScenePreviewUrl(e,t){var a="http://"+window.location.hostname+"/pano/"+e+"#id="+t;return a}function sceneTblAddRows(e){if(e instanceof Array){for(var t=$("#scene-tbl-id").DataTable(),a=0;a<e.length;a++){var n=e[a],i=n.thumbnail_res_id;""==i&&(i=n.res_id);var r=ResourceMgr.find(i),o='<img crossorigin="Anonymous" src="'+(r&&r.length>0?r[0].access_url:"")+'" style="width: 80px; height: 60px;">',l=dateFromSecond(n.create_time).toLocaleString(),c=$("<tr><td></td><td class='text-center-hiddin-more scene-title'>"+n.name+"</td><td class='text-center-hiddin-more scene-desc'>"+n.desc+"</td><td>"+o+"</td><td></td><td>"+l+'</td><td class="tbl-operation-d-cls">             <span onclick="onDeleteScene(event);">删除场景</span>             <span onclick="onEditSceneBaseInfo(this)">编辑</span>             <span onclick="onScenePointEidt(this);">点位管理</span>             <span onclick="onScenePreview(this);">预览</span>             <span onclick="onBottomLogoEdit(this)">底部logo</span>             </td></tr>');c.data("id",n.id),t.rows.add(c),updateSceneBottomLogo(n,c.get(0))}t.draw(!1)}else console.log("error params in sceneTblAddRows")}function onCreateProjectClick(e){$("#project-setting-mdl").modal({}),$("#project-name-psm").val(""),$("#project-description-psm").val("")}function updateProjectResource(){var e=[],t={};collectUnKnowRes(SLCProjManage.currProj,e,t),0!==e.length&&$.ajax({type:"post",data:JSON.stringify(e),url:"/api/getFiles",success:function(e){var a=e.data;validResMap(a,t)},async:!1}),ResourceMgr.update(t)}function onDeleteProject(e){if(confirm("您确定要删除此项目?")!==!1){var t=$(e.target).closest("tr"),a=t.data("id");$.ajax({type:"post",data:JSON.stringify({id:a}),url:"/api/deleteProject",success:function(e){if(0===e.err_code){var n=$("#project-tbl-id").DataTable();n.row(t).remove().draw(!1);var i=SLCProjManage.getProjectById(a);SLCProjManage.deleteProject(i)}}})}}function initPrjGenerater(){var e=getProjectUrl(SLCProjManage.currProj);$("#project-qrcode").empty(),$("#project-qrcode").qrcode(e),$("#prj-generater-url").val(e),$("#prj-generater-url").attr("readonly",!0)}function initPrjBaseInfo(){$("#prj-base-info-name").val(SLCProjManage.currProj.title).attr("readonly",!0),$("#prj-base-info-desc").val(SLCProjManage.currProj.desc).attr("readonly",!0),$("#edit-prj-base-info-btn").attr("disabled",!1),$("#save-prj-base-info-btn").attr("disabled",!0),$("#likeCheck").prop("checked",SLCProjManage.currProj.enable_like),$("#overlookCheck").prop("checked",SLCProjManage.currProj.enable_overlook),$("#autorotationCheck").prop("checked",SLCProjManage.currProj.enable_autorotation),$("#autoDeviceOrientationCheck").prop("checked",SLCProjManage.currProj.enable_orientation),$("#vrCheck").prop("checked",SLCProjManage.currProj.enable_vr)}function onEditProject(e){var t=e||window.event,a=t.target.parentNode.parentNode._DT_RowIndex,n=SLCProjManage.projs.length-1-a,i=SLCProjManage.projs[n];editProject(i)}function editProject(e){$("#scene-tbl-id").DataTable().clear().draw(),$("#project-qrcode").empty();var t=SLCUtility.callFunc("POST","getProject",{ids:[e.id],decode_res:!1});if(t&&0===t.err_code){SLCProjManage.currProj=t.data.projects[0],updateProjectInlist(SLCProjManage.currProj);var a=$("#tbl-scene-data-id");a.data("id",e.id),updateProjectResource();var n=e.scenes;n&&sceneTblAddRows(n),showPage("project-eidt-page"),$('a[href="#prj-scene-group-tab"]').trigger("shown.bs.tab"),initPrjGenerater(),initPrjBaseInfo()}}function onCreateSceneClick(){$("#scene-setting-mdl").modal({keyboard:!1,backdrop:!1}),$("#scene-setting-mdl").removeClass("lengthen"),$(".main-process","#scene-setting-mdl").show(),$(".select-process","#scene-setting-mdl").hide(),$("#scene-setting-mdl")[0].editScene=null,$("#scene-setting-mdl")[0].scene=null,$("#scene-name-psm").val(null),$("#scene-description-psm").val(null),$("#scene-setting-mdl .scene-img-area").empty(),$("#select_scenen_img").val(null),$("#scene-setting-mdl .modal-header .modal-title").text("创建场景")}function onDeleteScene(e){if(confirm("您确定要删除此场景?")!==!1){var t=$(e.target).closest("tr"),a=t.data("id"),n=$("#tbl-scene-data-id").data("id");$.ajax({type:"post",data:JSON.stringify({id:n,scenes:[{id:a}]}),url:"/api/deleteScene",success:function(e){if(0===e.err_code){var n=$("#scene-tbl-id").DataTable();SLCProjManage.deleteScene(SLCProjManage.currProj,a),n.row(t).remove().draw(!1)}}})}}function onSaveProjectSettingClick(){var e=$("#project-name-psm").val(),t=$("#project-description-psm").val();if(!e||0===e.length)return void alert("项目名称不能为空!");$("#project-setting-mdl").modal("hide");var a={title:e,desc:t},n=SLCUtility.callFunc("POST","addProject",a);if(n&&0===n.err_code){var i=n.data;SLCProjManage.projs.push(i);var r=$("#project-tbl-id").DataTable();r.clear(),projectTblAddRows(SLCProjManage.projs),editProject(i)}else alert("标题已被使用!")}function onBackToProjectManageClick(){showPage("project-list-page")}function onShareClick(e){var t=e||window.event;t.target.parentNode.parentNode.rowIndex}function onEidtScene(){showPage("scene-manage-page")}function onSelectFileClick(e){var t=$("#scene-setting-mdl")[0].editScene;if(t&&hasPoints(t))alert("不能更改已有点位的全景图。");else{var a=e||window.event;$(a.target).siblings("input").click()}}function onEditSceneBaseInfo(e){$("#scene-setting-mdl").modal({keyboard:!1,backdrop:!1}),$("#scene-setting-mdl").removeClass("lengthen"),$(".main-process","#scene-setting-mdl").show(),$(".select-process","#scene-setting-mdl").hide();var t=$(e).closest("tr").data("id"),a=sceneIdxById(t,SLCProjManage.currProj.scenes),n=SLCProjManage.currProj.scenes[a];$("#scene-setting-mdl")[0].editScene=n,$("#scene-setting-mdl")[0].scene=n.res_id,$("#scene-name-psm").val(n.name),$("#scene-description-psm").val(n.desc),$("#scene-setting-mdl .modal-header .modal-title").text("编辑场景"),$("#scene-setting-mdl .scene-img-area").empty();var i=$('<div class="img-cls"></div>'),r=new Image,o=ResourceMgr.find(n.res_id);o&&o.length&&(o=o[0]),r.crossOrigin="Anonymous",r.src=o?o.access_url:"",i.append(r),i.append($('<div class="file-name" title="'+(o?o.name:"")+'">'+(o?o.name:"")+"</div>")),$("#scene-setting-mdl .scene-img-area").append(i)}function onScenePreview(e){var t=$(e).closest("tr").data("id"),a=getScenePreviewUrl(SLCProjManage.currProj.id,t);$("#scene-preview-mdl")[0].sceneUrl=a,$("#scene-preview-mdl").modal("show")}function onScenePointEidt(e){$("#scene-point-edit-mdl").modal();var t=document.getElementById("scene-frame").contentWindow,a=$(e).closest("tr").data("id"),n=sceneIdxById(a,SLCProjManage.currProj.scenes);t.postMessage({type:"editScene",nSceneIdx:n},"*")}function updateSceneBottomLogo(e,t){var a,n=$("#scene-tbl-id").DataTable();if(e.bottom_logo&&e.bottom_logo.res_id){var i=ResourceMgr.find(e.bottom_logo.res_id);a='<img crossorigin="Anonymous" src="'+(i&&i.length>0?i[0].access_url:"")+'" style="width: 80px; height: 60px">'}else a="<p>该场景无底部logo</p>";n.cell($(t).children("td").eq(4)).data(a)}function onBottomLogoEdit(e){var t=$(e).closest("tr"),a=t.data("id"),n=sceneIdxById(a,SLCProjManage.currProj.scenes),i=function(){var e=SLCProjManage.currProj.scenes[n];updateSceneBottomLogo(e,t),$("#logo-setting-mdl").unbind("hide.bs.modal",i)};$("#logo-link-wrap").hide(),showLogoSetting(SLCProjManage.currProj.scenes[n].bottom_logo),$("#logo-setting-mdl").bind("hide.bs.modal",i)}function hasPoints(e){return e.jump_tags&&e.jump_tags.length||e.hyperlink_tags&&e.hyperlink_tags.length||e.introduce_tags&&e.introduce_tags.length||e.picture_tags&&e.picture_tags.length||e.voice_tags&&e.voice_tags.length}function onScenePointClose(e){$("#scene-point-edit-mdl").modal("hide")}function onImgFileChange(e){var t=e||window.event,a=t.target.files[0];if(a){$("#scene-setting-mdl")[0].scene=a,$("#scene-setting-mdl .scene-img-area").empty();var n=$('<div class="img-cls"></div>'),i=new Image;i.src=URL.createObjectURL(a),i.crossOrigin="Anonymous",n.append(i),n.append($('<div class="file-name" title="'+a.name+'">'+a.name+"</div>")),$("#scene-setting-mdl .scene-img-area").append(n),fileMd5(a)}}function lrzImg(e,t,a,n,i){var r={size:0,currtent:0,trigger:function(){r.currtent+=1,r.currtent==r.size&&o.upload()}},o=createUploadFileObj(t,r,a,n,i),l=e.name,c=l.lastIndexOf("."),s=l.substr(c),d=URL.createObjectURL(e),g=new Image;return g.onload=function(){var t=256,a=512;if(a>g.width)return o.cancel(),alert("上传的全景图像素太低(最小要求512*256)"),$(".img-cls").remove(),$(".spinner").remove(),void $("#select_scenen_img").val("");for(r.size+=1,e.md5Identifier=e.md5+".original.original"+s,o.addFile(e);a<=g.width;)r.size+=1,function(t,a){function n(n){var i;f>-1?i=new File([n],e.name,{type:e.type}):(i=n,n.name=e.name);var r="."+t.toString()+"."+a.toString();i.md5Identifier=e.md5+r+s,o.addFile(i)}var i=document.createElement("canvas");i.width=t,i.height=a;var r=i.getContext("2d");r.drawImage(g,0,0,t,a),gainCanvasBlob(i,n)}(a,t),a*=2,t*=2},g.src=d,e.md5}function addPanoFileInfo(e){var t="default",a=0;if($("#pano_link").closest("li").hasClass("active")){var n=$("#catelog-list li.active").find("p:first").text();"默认图册"!=n&&(t=n),a=$("#catelog-list li.active").index()}var i={oorigin_id:e,category:"panorama",tags:[t]},r=addfileinfo(i);SLCProjManage.panoCatelog&&SLCProjManage.panoCatelog.length>a&&(SLCProjManage.panoCatelog[a].data.push(r),$("#pano_pane")[0].tags&&$("#pano_pane")[0].tags.length>a&&($("#pano_pane")[0].tags[a].pane.filelist&&0!=$("#pano_pane")[0].tags[a].pane.filelist.length||($("#pano_pane")[0].tags[a].pane.filelist=[i]),$("#pano_pane")[0].tags[a].pane.update(!0)))}function addMaterialFileInfo(e){var t={oorigin_id:e,category:"material"},a=addfileinfo(t);SLCProjManage.materialList&&(SLCProjManage.materialList.push(a),$("#material_pane")[0].update(!0))}function validResource(e){for(var t=[],a=0;a<e.length;a++)e[a]&&""!=e[a]&&void 0===ResourceMgr.resources[e[a]]&&t.push(e[a]);if(t.length>0){var n=SLCUtility.callFunc("POST","getFiles",t).data;if(n){var i={};validResMap(n,i),ResourceMgr.update(i)}}}function onSaveSceneSettingClick(){function e(e,t){var a={id:SLCProjManage.currProj.id,scenes:[{name:i,desc:r,res_id:e,thumbnail_res_id:t}]};validResource([e,t]);var n=SLCUtility.callFunc("POST","addScene",a),o=!0;if(n&&0===n.err_code){for(var l=0;l<n.data.length;l++){var c=n.data[l];if(null==c.res_id||""==c.res_id){o=!1;break}}sceneTblAddRows(n.data);var s=SLCProjManage.currProj;void 0!==s.scenes&&null!==s.scenes||(s.scenes=[]),s.scenes=s.scenes.concat(n.data)}o?(alert("场景上传成功"),$("#scene-name-psm").val(""),$("#scene-description-psm").val(""),$("#scene-setting-mdl .img-cls").remove(),$("#select_scenen_img").val(""),$("#scene-setting-mdl").modal("hide")):alert("场景上传失败")}function t(e,t){var a=$("#scene-setting-mdl")[0].editScene;if(a.name===i&&a.desc===r&&a.res_id===e)return void $("#scene-setting-mdl").modal("hide");a.name=i,a.desc=r,a.res_id=e,t&&(a.thumbnail_res_id=t);var n={id:SLCProjManage.currProj.id,scenes:[a]};validResource([e,t]);var o=SLCUtility.callFunc("POST","updateScene",n),l=!0;if(o&&0===o.err_code)for(var c=0;c<o.data.length;c++){var s=o.data[c];if(null==s.res_id||""==s.res_id){l=!1;break}}l?(alert("场景更新成功"),$("#scene-tbl-id").DataTable().clear(),sceneTblAddRows(SLCProjManage.currProj.scenes),$("#scene-name-psm").val(""),$("#scene-description-psm").val(""),$("#scene-setting-mdl .img-cls").remove(),$("#select_scenen_img").val(""),$("#scene-setting-mdl").modal("hide")):alert("场景更新失败")}function a(e,t){function a(){r.remove(p),s.dispose(),g.dispose(),u.dispose(),m.clear()}function n(t){var n=jQuery.Deferred();n.done(function(t,n){e.done(a),uploadBlob(e,t,n,"thumb")}),getBlobMd5(n,t)}function i(){m.render(r,c),gainCanvasBlob(m.domElement,n)}var r=$("#scene-setting-mdl")[0].editScene;if(r&&r.res_id==t)return e.resolve();var o=$("img","#scene-setting-mdl .scene-img-area").get(0),l=document.createElement("canvas"),c=new THREE.PerspectiveCamera(75,2,1,1100);c.target=new THREE.Vector3(0,0,500);var r=new THREE.Scene,s=new THREE.SphereGeometry(500,60,40);s.scale(-1,1,1);var d=new THREE.TextureLoader;d.setCrossOrigin("");var g=new THREE.Texture;g.image=o,g.needsUpdate=!0;var u=new THREE.MeshBasicMaterial({map:g}),p=new THREE.Mesh(s,u);r.add(p);var m=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,canvas:l});m.setSize(256,128),o.complete?i():o.readystatechange=function(){i()}}function n(a,n,i){return null==a||void 0==a||""==a?void alert("场景上传失败"):(o?t(a,n):e(a,n),void(i&&addPanoFileInfo(a)))}var i=$("#scene-name-psm").val(),r=$("#scene-description-psm").val();if(!i||0===i.length)return void alert("场景名称不能为空!");var o=null!==$("#scene-setting-mdl")[0].editScene,l=$("#scene-setting-mdl")[0].scene;if(null===l||void 0===l||""==l)return void(o?t(null):alert("请选择场景!"));if("string"==typeof l){var c=jQuery.Deferred();c.done(function(e){n(l,e,!1)}),a(c,l)}else{$("#scene-setting-mdl button").attr("disabled",!0);var s=function(e){return function(){var t=e,i=jQuery.Deferred();i.done(function(e){n(t,e,!0)}),a(i,t),$("#scene-setting-mdl button").removeAttr("disabled",!0)}}(l.md5),d=function(){$("#scene-setting-mdl button").removeAttr("disabled",!0)};lrzImg(l,s,$("#scene-setting-mdl .modal-dialog"),!0,d)}}function createSceneByOther(){var e=$("#scene-name-psm").val();$("#scene-description-psm").val();if(!e||0===e.length)return void alert("项目名称不能为空!");if(void 0===ResourceMgr.resources[md5]){var t=SLCUtility.callFunc("POST","getFiles",[md5]).data;if(t){var a={};validResMap(t,a),ResourceMgr.update(a)}}}function playBackgroundMusic(){var e=$("#music")[0].files,t=$("#bg_music_player").get(0);if(e.length>0||""!==t.src&&void 0!==t.src)if($("#bg_music_player").get(0).paused){if(e.length>0){var a=URL.createObjectURL(e[0]);t.src=a}t.play(),$("#tryMusic").html("暂停")}else t.pause(),$("#tryMusic").html("试听");else alert("Selecting a music file first, please."),$("#music").trigger("click")}function miniSceneItem(e,t){if(e){var a=$("<li/>").addClass("mini-scene-item dropdown-item").data("idx",e.id);a.click(t);var n=ResourceMgr.find(e.res_id),i="";n&&n.length>0&&(i=n[0].access_url);$('<img crossorigin="Anonymous" />').addClass("mini-scene-img").attr("src",i).appendTo(a),$("<span/>",{text:e.name}).appendTo(a);return a}}function appendMiniSceneComponent(e){var t=addSandTablePoint($("#sand-table-mdl .sand-table-view"),e),a=miniSceneComponent(e,t);$("#sand-table-mdl .scene-list").append(a),$(a).find("li").trigger("click")}function miniSceneComponent(e,t){for(var a=void 0,n=SLCProjManage.currProj.scenes,i=0;i<n.length;++i)if(n[i].id==e.scene_id){a=n[i];break}a||(a={id:e.scene_id,name:"",res_id:""});var r=function(e){visible=$(l).siblings("form").is(":visible"),$(e.target).closest("div").siblings().removeClass("selected-mini-scene").children("form").hide(),$("#sand-table-mdl .sand-table-view .sand-table-arrow").removeClass("current"),visible?$(l).closest("div").removeClass("selected-mini-scene").children("form").hide():(t.addClass("current"),$(l).closest("div").addClass("selected-mini-scene"),$(l).siblings("form").show())},o=$("<div></div>"),l=miniSceneItem(a,r);$(l).addClass("mini-scene-picked-item").appendTo(o);var c=$.parseHTML('<form class="sand-point-form clearfix">             <div class="clearfix">                 <label class="left" for="'+e.scene_id+'-x">X轴</label>                <input class="right" id="'+e.scene_id+'-x" type="range" min="0" max="1" value="'+e.percentx+'" step="0.01">            </div>            <div class="clearfix">                <label class="left" for="'+e.scene_id+'-y">Y轴</label>                <input class="right" id="'+e.scene_id+'-y" type="range" min="0" max="1" value="'+e.percenty+'" step="0.01">            </div>            <div class="clearfix">                <label class="left" for="'+e.scene_id+'-v">视角</label>                <input class="right" id="'+e.scene_id+'-v" type="range" min="0" max="360" value="'+e.angle+'">            <div>        <form>');o.append(c);var s=$("#sand-table-mdl .sand-table-view"),d="#"+e.scene_id+"-";return $(c).find(d+"x").on("input change",function(){t.css("left",$(this).val()*s.width())}),$(c).find(d+"y").on("input change",function(){t.css("top",$(this).val()*s.height())}),$(c).find(d+"v").on("input change",function(){t.css("transform","rotate("+$(this).val()+"deg)")}),$(c).hide(),o}function collectCurrentProjectSandPointInfo(){var e=SLCProjManage.currProj.sand_table;e.points=[],$(".scene-list form").each(function(t,a){var n=$(a).find("input"),i=$(a).siblings("li").data("idx"),r={percentx:Number(n[0].value),percenty:Number(n[1].value),angle:Number(n[2].value),scene_id:Number(i)};e.points.push(r)})}function adjustLogoImgSize(e){var t=e||window.event,a=t.target,n=250;(a.width>n||a.height>n)&&(a.width/a.height>1?(a.height=n*a.height/a.width,a.width=n):(a.width=n*a.width/a.height,a.height=n)),$(a).css("display","")}function showLogoSetting(e,t){e&&""!==e.title?$("#logo-title").val(e.title):$("#logo-title").val(""),$("#logo-setting-mdl").modal({backdrop:!1,keyboard:!1});var a=$("#logo-img-area");if(a.empty(),""!==e.res_id){var n=new Image;n.crossOrigin="Anonymous",n.src=ResourceMgr.decodeRes(e.res_id),n.onload=adjustLogoImgSize,$(n).css("display","none"),a.append(n)}else a.append("<div>此项目没有设置对应的logo图标</div>");setDoneLogo(e,t)}function setDoneLogo(e,t){$("#done-logo").unbind("click"),$("#done-logo").bind("click",function(){var a=$("#file-logo")[0].files,n=$("#logo-title").val(),i=$("#logo-img-area").children("img");if(0===i.length&&(e.res_id=""),t&&t(),a&&a.length>0){if(""===n||void 0===n)return void alert("标题不能为空");n!=e.title&&(e.title=n);var r=spinnerOpts(),o=(new Spinner(r).spin($("#logo-setting-mdl .modal-dialog").get(0)),$("#logo-setting-mdl .modal-dialog button")),l=a[0],c=a[0].name,s=c.lastIndexOf("."),d=c.substr(s);l.md5Identifier=l.md5+".original.original"+d;var g=function(){e.res_id=l.md5,$("#file-logo").val(""),o.each(function(){$(this).removeAttr("disabled")}),res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code&&(SLCProjManage.currProj=res.data,updateProjectInlist(SLCProjManage.currProj)),updateProjectResource(),$(".spinner").remove(),$("#logo-setting-mdl").modal("hide")},u={size:1,currtent:0,trigger:function(){u.currtent+=1,u.currtent==u.size&&p.upload()}};o.each(function(){$(this).attr("disabled",!0)});var p=createUploadFileObj(g,u);p.addFile(l)}else $("#file-logo")[0].url&&(e.res_id=$("#file-logo")[0].url),n!=e.title&&(e.title=n),res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code&&(SLCProjManage.currProj=res.data,updateProjectInlist(SLCProjManage.currProj)),$("#logo-setting-mdl").modal("hide")})}function getLinkBtnRow(){var e='<tr>         <td>             <img class="ico" src="../img/link.png" title="更改图标" disabled></img>            <input type="file" class="ico-input" accept="image/*" style="position: fixed; top: -100em" disabled>             <div>             <span class="used-other btn-primary disabled">素材库</span>             <span class="local-file btn-primary disabled">本地上传</span>             </div>         </td>         <td><input class="title" placeholder="输入标题" disabled></td>         <td><input class="url" placeholder="输入完整的链接或电话号码" disabled></td>         <td class="tbl-operation-d-cls"><span class="edit">编辑</span> <span class="delete">删除</span></td>     </tr>',t=$(e);return t.find("span.delete").click(function(){if(confirm("您确定要删除此项目?")!==!1){var e=$("#links-tbl-id").DataTable();e.row($(this).closest("tr")).remove().draw(!1)}}),t.find("span.edit").click(function(){var e=t.closest("table");e.find("input").attr("disabled",!0),e.find("img").attr("disabled",!0),e.find("span.used-other, span.local-file").addClass("disabled"),e.find("span.edit").removeAttr("disabled").removeClass("disabled"),t.find("input").removeAttr("disabled"),t.find("img").removeAttr("disabled"),t.find("span.used-other, span.local-file").removeClass("disabled"),t.find("span.edit").attr("disabled",!0).addClass("disabled")}),t.find(".ico-input").change(function(){var e=t.find(".ico-input")[0].files;fileMd5(e[0]);var a=URL.createObjectURL(e[0]);t.find("img").attr("src",a)}),t.find(".local-file").click(function(){t.find(".ico-input").trigger("click")}),t.find("span.used-other").click(function(){if(!$(this).hasClass("disabled")){var e=$("#links-tbl-id").DataTable(),a=function(a){a&&(t.find("img").attr("src",ResourceMgr.decodeRes(a.oorigin_id)),t.find(".ico").data("res_id",a.oorigin_id),e.row($(this).closest("tr")).draw(!1))};SelectMaterial($("#custom-link-mdl")[0],a)}}),t}function showLinksModal(){var e;e=$.fn.dataTable.isDataTable("#links-tbl-id")?$("#links-tbl-id").DataTable():$("#links-tbl-id").DataTable({bPaginate:!1,bFilter:!1,bInfo:!1,language:{zeroRecords:"没有找到记录",sEmptyTable:"没有找到记录"}}),e.clear();for(var t=SLCProjManage.currProj.links,a=0;a<t.length;a++){var n=t[a],i=ResourceMgr.find(n.ico);i||(updateResourceFromIds([n.ico]),i=ResourceMgr.find(n.ico));var r=i&&i.length>0?i[0].access_url:"../img/link.png",o=getLinkBtnRow();o.find(".ico").attr("src",r).data("res_id",n.ico),o.find(".title").val(n.title),o.find(".url").val(n.content),e.rows.add(o)}e.draw(!1),$("#custom-link-mdl").modal("show")}function showBtnsModal(){var e;e=$.fn.dataTable.isDataTable("#btns-tbl-id")?$("#btns-tbl-id").DataTable():$("#btns-tbl-id").DataTable({bPaginate:!1,bFilter:!1,bInfo:!1,language:{zeroRecords:"没有找到记录",sEmptyTable:"没有找到记录"}}),e.clear();for(var t=SLCProjManage.currProj.buttons,a=0;a<t.length;a++){var n=t[a],i=ResourceMgr.find(n.ico);i||(updateResourceFromIds([n.ico]),i=ResourceMgr.find(n.ico));var r=i&&i.length>0?i[0].access_url:"../img/link.png",o=getCustomBtnRow();o.find(".ico").attr("src",r).data("res_id",n.ico).data("idx",a),o.find(".title").val(n.title),o.find(".content").val(n.content),e.rows.add(o)}e.draw(!1),$("#custom-btn-mdl").modal("show")}function getCustomBtnRow(){var e='<tr>         <td>             <img class="ico" src="../img/link.png" disabled></img>            <input type="file" class="ico-input" accept="image/*" style="position: fixed; top: -100em" disabled>             <div>             <span class="used-other btn-primary disabled">素材库</span>             <span class="local-file btn-primary disabled">本地上传</span>             </div>         </td>         <td><input placeholder="输入标题" class="title" disabled></td>         <td><textarea placeholder="输入你要呈现的内容（支持html）" class="content" disabled></textarea></td>         <td class="tbl-operation-d-cls"><span class="edit">编辑</span> <span class="preview">预览</span> <span class="delete">删除</span></td>     </tr>',t=$(e);return t.find("span.delete").click(function(){if(confirm("您确定要删除此项目?")!==!1){var e=$("#btns-tbl-id").DataTable();e.row($(this).closest("tr")).remove().draw(!1)}}),t.find("span.preview").click(function(){var e=t.find(".content").val(),a=t.find(".title").val();$("#custom-btn-preview-mdl .modal-title").text(a),$("#custom-btn-preview-mdl .modal-body").empty().append($("<div>"+e+"</div>")),$("#custom-btn-preview-mdl").modal("show")}),t.find("span.edit").click(function(){var e=t.closest("table");e.find("input").attr("disabled",!0),e.find("textarea").css("height","auto").attr("disabled",!0),e.find("img").attr("disabled",!0),e.find("span.used-other, span.local-file").addClass("disabled"),e.find("span.edit").removeAttr("disabled").removeClass("disabled"),t.find("input").removeAttr("disabled"),t.find("textarea").css("height","80px").removeAttr("disabled"),t.find("img").removeAttr("disabled"),t.find("span.used-other, span.local-file").removeClass("disabled"),t.find("span.edit").attr("disabled",!0).addClass("disabled")}),t.find(".ico-input").change(function(){var e=t.find(".ico-input")[0].files;fileMd5(e[0]);var a=URL.createObjectURL(e[0]);t.find("img").attr("src",a)}),t.find("span.local-file").click(function(){t.find(".ico-input").trigger("click")}),t.find("span.used-other").click(function(){if(!$(this).hasClass("disabled")){var e=$("#btns-tbl-id").DataTable(),a=function(a){a&&(t.find("img").attr("src",ResourceMgr.decodeRes(a.oorigin_id)),t.find(".ico").data("res_id",a.oorigin_id),e.row($(this).closest("tr")).draw(!1))};SelectMaterial($("#custom-btn-mdl")[0],a,"image")}}),t}function updateProjectInlist(e){for(var t=SLCProjManage.projs,a=0;a<t.length;a++)if(t[a].id==e.id){t[a]=e;break}}function changeCheckSetting(e,t){SLCProjManage.currProj[e]=t;var a=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj);a&&0!==a.err_code?(SLCProjManage.currProj[e]=!t,alert("设置失败!")):updateProjectInlist(SLCProjManage.currProj)}function returnSceneSettingClick(){$("#scene-setting-mdl").removeClass("lengthen"),$(".main-process","#scene-setting-mdl").show(),$(".select-process","#scene-setting-mdl").hide()}function selectPanoClick(){var e=$("#pano_select")[0],t="",a="";if(e.selected.length>0){$("#scene-setting-mdl")[0].scene=e.selected[0].oorigin_id;var n=ResourceMgr.find(e.selected[0].oorigin_id);n&&n.length>0&&(t=n[0].name,a=n[0].access_url),e.selected=[]}else $("#scene-setting-mdl")[0].scene="";$("#scene-name-psm").val()||$("#scene-name-psm").val(t);var i=$('<div class="img-cls"></div>'),r=new Image;r.crossOrigin="Anonymous",r.src=a,i.append(r),""!=t&&i.append($('<div class="file-name" title="'+t+'">'+t+"</div>")),$(".scene-img-area","#scene-setting-mdl").empty(),$(".scene-img-area","#scene-setting-mdl").append(i),returnSceneSettingClick()}function onDelPanoImage(e){var t=$("#scene-setting-mdl")[0].editScene;return t&&hasPoints(t)?void alert("不能删除已有点位的全景图。"):void(confirm("你确定要删除此场景的全景图吗？")!==!1&&($("#scene-setting-mdl .img-cls").remove(),$("#select_scenen_img").val(""),$("#scene-setting-mdl")[0].scene=null))}function onSelectPanoClick(e){function t(e){return"default"==e?"默认图册":e}function a(e){for(var t=e.dataSrc,a=$("#pano_select")[0],n=[],i=0;i<a.selected.length;i++)if(a.selected[i]==t){n.push(a.selected[i]);break}a.selected=n,$(e).siblings(".selected").removeClass("selected")}function n(e,n){e.hide(),e.siblings("li").show(),l.html(t(SLCProjManage.panoCatelog[n].name)+'  <span class="caret"></span>'),initFileListPane($("#pano_select")[0],SLCProjManage.panoCatelog[n].data,2,a)}var i=$("#scene-setting-mdl")[0].editScene;if(i&&hasPoints(i))return void alert("不能更改已有点位的全景图。");var r=$(e.target).closest(".main-process");if(0!=r.length){r.hide(),r.siblings(".select-process").show(),$("#scene-setting-mdl").addClass("lengthen"),validPanoCatelog();var o='<li><a href="#">{name}</a></li>',l=$(".select-tag","#pano_select"),c=l.siblings(".dropdown-menu");c.empty(),c.unbind("click");for(var s=0;s<SLCProjManage.panoCatelog.length;s++){var d={name:t(SLCProjManage.panoCatelog[s].name)},g=$(o.format(d));g.appendTo(c)}c.bind("click",function(e){var t=$(e.target).closest("li");if(t.length>0){var a=$("li",c).index(t[0]);n(t,a)}l.trigger("click"),e.stopPropagation()}),n($("li:first",c),0)}}function validPanoCatelog(){if(!SLCProjManage.panoCatelog||0==SLCProjManage.panoCatelog.length){var e=getFileList("panorama");SLCProjManage.panoCatelog=splitCategory(e)}}function ShowPanoList(){validPanoCatelog(),$("#pano_pane")[0].tags&&0!=$("#pano_pane")[0].tags.length||initPanoPane()}function getMaterialList(){return SLCProjManage.materialList&&0!=SLCProjManage.materialList.length||(SLCProjManage.materialList=getFileList("material")),SLCProjManage.materialList}function ShowMaterialList(){initFileListPane($("#material_pane")[0],getMaterialList(),2)}function updateFileinfo(e){var t=null;return $.ajax({type:"POST",data:JSON.stringify(e),url:"/api/updateFileinfo",success:function(e){0===e.err_code&&(t=e.data)},async:!1}),t}function deleteFileinfo(e){for(var t=null,a=[],n=0;n<e.length;n++)a.push(e[n].id);return $.ajax({type:"POST",data:JSON.stringify(a),url:"/api/deleteFileinfo",success:function(e){0===e.err_code&&(t=e.data)},async:!1}),t}function deleteCatelogTag(e){var t=!1;return $.ajax({type:"POST",data:JSON.stringify({category:"panorama",tags:e}),url:"/api/deleteCategoryTag",success:function(e){0===e.err_code&&(t=!0)},async:!1}),t}function addCategoryTag(e,t,a){function n(e){return"default"==e?"默认图册":e}var i='<li><a href="#"><p>{name}</p></a> </li>',r='<div style="overflow:hidden; display: none">                  <div class="pane" style="overflow:hidden;">                   </div>                  <div class="page" style="margin-top: float:right">                  <label class="is-show-unique-wrap">不重复:<input class="is-show-unique" type="checkbox"></label>                    <button class="preview"> 上一页 </button>                  <span class="cur-page">1/1</span>                   <button class="next"> 下一页 </button>                 <input class="jump-page"> </input>                    <button class="jump-btn">跳转</button>                  </div> </div>',o=$(i.format({name:n(e)}));o.appendTo($("#catelog-list"));var l=$(r).appendTo($("#pano_pane"));initFileListPane(l[0],t,2);var c={title:n(e),name:e,data:t,pane:l[0],head:o[0]};$("#pano_pane")[0].tags.push(c),a||$('<span class="glyphicon glyphicon-remove-circle panolist-delete-img"></span>').prependTo(o.children("a:first"))}function splitCategory(e){for(var t={default:[]},a=["default"],n=0;n<e.length;n++)void 0===t[e[n].tags[0]]&&(t[e[n].tags[0]]=[]),""==e[n].oorigin_id&&"default"!=e[n].tags[0]&&a.push(e[n].tags[0]),t[e[n].tags[0]].push(e[n]);for(var i=[],n=0;n<a.length;n++){for(var r=a[n],o=[],l=0;l<t[r].length;l++)""!==t[r][l].oorigin_id&&o.push(t[r][l]);i.push({name:r,data:o})}return i}function initPanoPane(){function e(e){var t=$(e.target).closest("li");if(0!=t.length){var a=$("#catelog-list > li").index(t[0]);if(!t.hasClass("active")){t.siblings(".active").removeClass("active"),t.addClass("active");for(var n=0;n<i.length;n++)$(i[n].pane).hide();$(i[a].pane).show()}}}function t(e){var t=$(e.target).closest("li");if(0!=t.length){var a=$("#catelog-list > li").index(t[0]),n=-1;t.hasClass("active")&&(n=a,a+1==$("#pano_pane")[0].tags.length&&n--);var r=!0;if(i[a].data&&i[a].data.length>0&&(r=confirm("确定删除该图册及包含的图片？")),!r)return!1;deleteCatelogTag(i[a].name),$(i[a].pane).hide(),t.remove(),$(i[a].pane).remove(),SLCProjManage.panoCatelog.slice(a,1),$("#pano_pane")[0].tags.splice(a,1),n>=0&&($(i[n].pane).show(),$("#catelog-list > li").eq(n).addClass("active"))}}var a=SLCProjManage.panoCatelog;if($("#pano_pane").empty(),$("#pano_pane")[0].tags=[],0!=a.length){for(var n=0;n<a.length;n++)addCategoryTag(a[n].name,a[n].data,"default"==a[n].name);$("#catelog-list > li").eq(0).addClass("active");
var i=$("#pano_pane")[0].tags;$(i[0].pane).show(),$("#catelog-list").bind("click",function(a){return 0!=$(a.target).closest(".panolist-delete-img").length?t(a):e(a)})}}function removeArrVals(e,t){for(var a=0;a<t.length;a++){var n=$.inArray(t[a],e);n>=0&&e.splice(n,1)}}function addArrVals(e,t){for(var a=0;a<t.length;a++)e.push(t[a])}function getSamePicFileInfos(e,t){function a(e){var t=null;return e.tags&&e.tags.length>0&&(t=e.tags[0]),t}for(var n=[],i=0;i<e.length;i++)for(var r=a(e[i]),o=0;o<t.length;o++)e[i].oorigin_id==t[o].oorigin_id&&r==a(t[o])&&n.push(e[i]);return n}function SelectMaterial(e,t,a){function n(e){var t=e.dataSrc;o==t?($(e).removeClass("selected"),o=null,r.selected=[t]):($(e).addClass("selected"),o=t,r.selected=[]),$(e).siblings(".selected").removeClass("selected")}var i=$("#mertial-select-mdl"),r=$(".pane",i),o=null;$(e).modal("hide"),i.modal({keyboard:!1,backdrop:!1}),$(".btn-default","#mertial-select-mdl").unbind("click"),$(".btn-primary","#mertial-select-mdl").bind("click",function(){return o?(t(o),i.modal("hide"),void $(e).modal({keyboard:!1,backdrop:!1})):(alert("请选择文件"),!1)}),$(".btn-default","#mertial-select-mdl").unbind("click"),$(".btn-default","#mertial-select-mdl").bind("click",function(){return i.modal("hide"),$(e).modal({keyboard:!1,backdrop:!1}),!1}),$(".btn-primary","#mertial-select-mdl").unbind("click"),$(".btn-primary","#mertial-select-mdl").bind("click",function(){return o?($(e).modal({keyboard:!1,backdrop:!1}),t(o),void i.modal("hide")):(alert("请选择文件"),!1)});var l=filterFile(getMaterialList(),a),r=$("#pano_select",i);initFileListPane(r,l,2,n)}function addImgView(e,t){var a=SLCProjManage.currProj.scenes,n=sceneIdxById(e,a);n>=0&&sceneImageView(a[n]).click(function(){$(this).hasClass("selected")?$(this).removeClass("selected"):$(this).addClass("selected")}).appendTo(t)}function validGroupName(e){var t=$("#prj-scene-group-tab .scene-group-content .nav-pills li"),a=!1;t.each(function(t,n){var i=$(n).data("name");i===e&&(a=!0)});var n=/[`~!@ #$%^&*()+<>?:"{},.\/;'[\]]/im;return!a&&!n.test(e)}function createGroupUi(e,t,a,n){if(!e)return a||alert("分组名称不能为空!"),null;var i=$("#prj-scene-group-tab .scene-group-content .nav-pills li"),r=!validGroupName(e);if(r)return a||alert("不能使用重复的名称或名称中包含`~!@ #$%^&*()+<>?:\"{},./;'[]等非法字符。"),null;var o='<li><a href="#'+e+'"  role="tab" data-toggle="tab"><span class="name"> '+e+"</span>("+t.length+")",l='<span class="glyphicon glyphicon-remove-circle panolist-delete-img"></span><span class="glyphicon glyphicon glyphicon-edit panolist-edit-name"></span></a></li>';o+=n?"</a></li>":l;var c=$(o);c.data("name",e).click(function(e){n?$("#prj-scene-group-tab .btns-tbl").hide():$("#prj-scene-group-tab .btns-tbl").show()}),n?c.insertBefore(i.first()):c.insertBefore(i.last()),$("span.panolist-delete-img",c).click(function(){var e=$(this).closest("li"),t=e.data("name");e.remove();var a=$("#prj-scene-group-tab .add-group .dropdown-menu"),n=$("#prj-scene-group-tab #"+t+" .scene-img-area"),i=SLCProjManage.currProj.scenes;$(".img-cls",n).each(function(e,t){var n=$(t).data("_id"),r=sceneIdxById(n,i);groupAddListItem(i[r]).appendTo(a),addImgView(n,$("#prj-scene-group-tab #默认 .scene-img-area"))}),$("#prj-scene-group-tab #"+t).remove()});for(var s=$('<div role="tabpanel" class="tab-pane"><div class="scene-img-area"></div></div>').attr("id",e),d=$(".scene-img-area",s),g=0;g<t.length;g++)addImgView(t[g],d);return $("span.panolist-edit-name",c).click(function(){var e=$(this).closest("li").get(0);$("#rename-mdl").data("info",{title:"场景分组重命名",value:$(e).data("name"),callback:function(t){var a=$(e).data("name");if(t==a)return!0;if(!validGroupName(t))return alert("不能使用重复的名称或名称中包含`~!@ #$%^&*()+<>?:\"{},./;'[]等非法字符。"),!1;$(e).data("name",t);$("a span.name",$(e)).text();return $("a span.name",$(e)).text(" "+t),$("a",$(e)).attr("href","#"+t),$("#"+a).attr("id",t),!0}}),$("#rename-mdl").modal("show")}),$("#prj-scene-group-tab .scene-group-content .tab-content").append(s),c}function groupAddListItem(e){return miniSceneItem(e,function(e){var t=$(e.target).closest("li"),a=t.data("idx");t.remove();var n=$("#prj-scene-group-tab .scene-group-content .nav li.active").data("name"),i=$("#prj-scene-group-tab #"+n+" .scene-img-area");addImgView(a,i);var r=$("#prj-scene-group-tab #默认 .scene-img-area");$(".img-cls",r).each(function(e,t){$(t).data("_id")==a&&$(t.remove())})})}function initGroupAddlist(e){var t=$("#prj-scene-group-tab .add-group .dropdown-menu");t.empty();for(var a=SLCProjManage.currProj.scenes,n=0;n<e.length;n++){var i=sceneIdxById(e[n],a);groupAddListItem(a[i]).appendTo(t)}}function initGroupInfo(){$("#prj-scene-group-tab .scene-group-content .tab-content").empty();var e=$("#prj-scene-group-tab .scene-group-content .nav-pills li");e.length>1&&e.slice(0,e.length-1).remove();var t=SLCProjManage.currProj.scenes,a=[];$.each(t,function(e,t){a.push(t.id)});for(var n=SLCProjManage.currProj.scene_groups,i=0;i<n.length;i++){var r=n[i];a=$(a).not(r.scenes).get(),createGroupUi(r.title,r.scenes,!0,!1)}if(a.length){createGroupUi("默认",a,!0,!0);initGroupAddlist(a)}}var const_page_size=10,SLCProjManage={projs:null,currProj:null,deleteScene:function(e,t){for(var a=0;a<e.scenes.length;a++)if(e.scenes[a].id==t){e.scenes.splice(a,1);break}},deleteProject:function(e){for(var t=0;t<SLCProjManage.projs.length;t++)if(SLCProjManage.projs[t]==e){SLCProjManage.projs.splice(t,1);break}SLCProjManage.currProj==e&&(SLCProjManage.currProj=null)},getProjectById:function(e){for(var t=0;t<SLCProjManage.projs.length;t++)if(SLCProjManage.projs[t].id==e)return SLCProjManage.projs[t]},panoCatelog:null,materialList:null};$(document).ready(function(){checkAuth(!0);var e=SLCUtility.callFunc("POST","getProjectList",{});if(e&&0===e.err_code&&(e=SLCUtility.callFunc("POST","getProject",{ids:e.data,decode_res:!1}),e&&0===e.err_code)){SLCProjManage.projs=e.data.projects;var t={lengthMenu:"每页 _MENU_ 条记录",zeroRecords:"没有找到记录",sEmptyTable:"没有找到记录",info:"第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",infoEmpty:"无记录",infoFiltered:"(从 _MAX_ 条记录过滤)",sSearch:"查找：",oPaginate:{sPrevious:"上一页",sNext:"下一页"}};$("#project-tbl-id").dataTable({fnRowCallback:function(e,t,a,n){$("td:eq(0)",e).html(n+1)},language:t,dom:'<"left"f>t<ip<"right page-leght-selector"l>>'}),projectTblAddRows(SLCProjManage.projs),$("#scene-tbl-id").dataTable({fnRowCallback:function(e,t,a,n){$("td:eq(0)",e).html(n+1)},language:t,dom:'<"left"f>t<ip<"right page-leght-selector"l>>'}),$("#select_music").click(function(e){e.preventDefault(),$("#music").trigger("click")}),$("#music").change(function(e){var t=$("#music")[0].files;t.length>0&&""===$("#music_title").val()&&$("#music_title").val(t[0].name)}),$("#select_material_sound").click(function(e){var t=function(e){if(e){$("#music").val("");var t=$("#bg_music_player").get(0),a=ResourceMgr.find(e.oorigin_id);a&&0!=a.length&&(t.src=a[0].access_url,$("#music_title").val(a[0].name),$("#music")[0].res_id=e.oorigin_id)}};SelectMaterial($("#music-setting-mdl")[0],t,"audio")}),jumpUrlAnchor()}});var showPage=function(){var e=["project-list-page","overall-view-setting","project-setting-page","scene-manage-page","project-eidt-page","material-edit-page"];return function(t){for(var a=0;a<e.length;a++)e[a]===t?$("#"+e[a]).show():$("#"+e[a]).hide()}}();$("#prj-edit-prj-generater .copy-btn").click(function(){$("#prj-generater-url").select(),document.execCommand("copy")}),$("#scene-preview-mdl").on("hidden.bs.modal",function(e){$("#scene-preview-frame").remove()}).on("shown.bs.modal",function(e){$(".scene-preview-container-2").append('<iframe id="scene-preview-frame" scrolling="no" src="'+$("#scene-preview-mdl")[0].sceneUrl+'"></iframe>')}),$("#scene-point-edit-mdl").on("hidden.bs.modal",function(e){var t=document.getElementById("scene-frame").contentWindow;t.postMessage({type:"clearScene"},"*");var a=SLCUtility.callFunc("POST","getProject",{ids:[SLCProjManage.currProj.id],decode_res:!1});a&&0===a.err_code&&(SLCProjManage.currProj=a.data.projects[0],updateProjectResource())}),$("#set_music").click(function(){var e=SLCProjManage.currProj.background_music;""!==e.title?$("#music_title").val(e.title):$("#music_title").val(""),$("#music-setting-mdl").modal({backdrop:!1,keyboard:!1});var t=$("#bg_music_player").get(0);""!==e.res_id?t.src=ResourceMgr.decodeRes(e.res_id):t.src="",$("#music").val(""),$("#music")[0].res_id=""}),$("#music").change(function(){var e=$("#music")[0].files;e&&e.length>0&&(fileMd5(e[0],null),$("#music")[0].res_id="")}),$("#deleteMusic").click(function(){$("#music_title").val(""),$("#music").val(""),$("#bg_music_player").val("");var e=SLCProjManage.currProj.background_music;e.title="",e.res_id=null}),$("#musicDone").click(function(){var e=SLCProjManage.currProj.background_music;$("#music_title").val()!=e.title&&(e.title=$("#music_title").val());var t=$("#music")[0].files;if((""===$("#music_title").val()||void 0===$("#music_title").val())&&(t&&t.length>0||$("#music")[0].res_id))return void alert("标题不能为空");if(t&&t.length>0){var a=t[0],n=t[0].name,i=$("#music-setting-mdl .modal-dialog button");i.each(function(){$(this).attr("disabled",!0)});var r=n.lastIndexOf("."),o=n.substr(r);a.md5Identifier=a.md5+".original.original"+o;var l=function(){i.each(function(){$(this).removeAttr("disabled")}),e.res_id=a.md5,$("#music").val(""),res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code&&(SLCProjManage.currProj=res.data,updateProjectInlist(SLCProjManage.currProj)),updateProjectResource(),$("#music-setting-mdl").modal("hide")},c={size:1,currtent:0,trigger:function(){c.currtent+=1,c.currtent==c.size&&s.upload()}},s=createUploadFileObj(l,c,$("#music-setting-mdl .modal-dialog"));s.addFile(a)}else $("#music")[0].res_id&&""!=$("#music")[0].res_id&&(e.res_id=$("#music")[0].res_id),res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code&&(SLCProjManage.currProj=res.data,updateProjectInlist(SLCProjManage.currProj)),$("#music-setting-mdl").modal("hide")}),$("#generate-qrcode-btn").click(function(e){var t=getProjectUrl(SLCProjManage.currProj);$("#project-qrcode").empty(),$("#project-qrcode").qrcode(t)}),$("#set-sand-table").click(function(){var e=SLCProjManage.currProj.sand_table;if(e.res_id){var t=ResourceMgr.decodeRes(e.res_id);$("#sand-table-pic").attr("src",t)}var a=$("#sand-pic-input")[0].files,n=a&&a.length>0||e.res_id;n&&SLCProjManage.currProj.scenes.length?$("#sand-add-scene").removeAttr("disabled"):$("#sand-add-scene").attr("disabled",!0),e.res_id||$("#sand-table-pic").attr("src","../img/add-pic.png"),$(".mini-scene-item").remove();for(var i=0;i<e.points.length;++i)appendMiniSceneComponent(e.points[i]);$("#sand-table-mdl").modal({backdrop:!1,keyboard:!1})}),$("#sand-add-scene").click(function(){$("#sand-table-mdl .dropdown-menu").empty(),$.each(SLCProjManage.currProj.scenes,function(e){function t(e){var t=$(e.target).closest("li");stp={percentx:.5,percenty:.5,angle:0,scene_id:t.data("idx")},appendMiniSceneComponent(stp)}var a=SLCProjManage.currProj.scenes[e];$("#sand-table-mdl .dropdown-menu").append(miniSceneItem(a,t))})}),$("#sand-table-pic").click(function(e){e.preventDefault(),$("#sand-pic-input").trigger("click")}),$("#sand-pic-input").change(function(e){var t=$("#sand-pic-input")[0].files;t&&t.length>0&&fileMd5(t[0],null);var a=$("#sand-table-pic").get(0);a.src=URL.createObjectURL(t[0]),$("#sand-add-scene").removeAttr("disabled")}),$("#sand-del-scene").click(function(){var e=$(".scene-list .selected-mini-scene li").data("idx");e&&(sandPointView(e).remove(),$(".scene-list .selected-mini-scene").remove())}),$("#sand-table-del").click(function(){$("#sand-table-pic").attr("src","../img/add-pic.png"),$("#sand-table-pic").data("del",!0),$(".sand-table-arrow").remove(),$("#sand-table-mdl .scene-list").empty()}),$("#sand-table-done").click(function(){collectCurrentProjectSandPointInfo(),$(".scene-list").empty();var e=function(){res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code&&(SLCProjManage.currProj=res.data,updateProjectInlist(SLCProjManage.currProj)),updateProjectResource(),$("#sand-table-mdl").modal("hide"),$(".sand-table-arrow").remove()},t=SLCProjManage.currProj.sand_table,a=$("#sand-pic-input")[0].files;if(!a.length){var n=$("#sand-table-pic").data("del");return 1==n&&($("#sand-table-pic").data("del",!1),t.res_id=null),void e()}var i=a[0],r=a[0].name,o=r.lastIndexOf("."),l=r.substr(o);i.md5Identifier=i.md5+".original.original"+l;var c=function(){t.res_id=i.md5,$("#sand-pic-input").val(""),$("#sand-table-pic").val(""),e()},s={size:1,currtent:0,trigger:function(){s.currtent+=1,s.currtent==s.size&&d.upload()}},d=createUploadFileObj(c,s,$("#sand-table-mdl .modal-dialog"));d.addFile(i)}),$("#logo-setting-btn").click(function(){var e=function(){SLCProjManage.currProj.logo_link=$("#logo-link").val()};$("#logo-link-wrap").show(),$("#logo-link").val(SLCProjManage.currProj.logo_link),showLogoSetting(SLCProjManage.currProj.logo,e)}),$("#select-logo").click(function(e){e.preventDefault(),$("#file-logo").trigger("click")}),$("#delete-logo").click(function(e){$("#logo-img-area").empty(),$("#logo-title").val(""),$("#file-logo").val(""),$("#file-logo").get(0).url=null}),$("#set-bottom-logo").click(function(){$("#logo-link-wrap").hide(),showLogoSetting(SLCProjManage.currProj.bottom_logo)}),$("#file-logo").change(function(e){var t=$("#file-logo")[0].files;if($("#file-logo")[0].url=null,t.length>0){0===$("#logo-title").val().length&&$("#logo-title").val(t[0].name),fileMd5(t[0],null);var a=new Image,n=URL.createObjectURL(t[0]);a.src=n,$(a).css("display","none"),a.onload=adjustLogoImgSize,$("#logo-img-area").empty(),$("#logo-img-area").append(a)}}),$("#set-share-logo").click(function(){$("#logo-link-wrap").hide(),showLogoSetting(SLCProjManage.currProj.share_logo)}),$("#edit-prj-base-info-btn").click(function(e){$("#edit-prj-base-info-btn").attr("disabled",!0),$("#save-prj-base-info-btn").attr("disabled",!1),$("#prj-base-info-name").attr("readonly",!1),$("#prj-base-info-desc").attr("readonly",!1)}),$("#save-prj-base-info-btn").click(function(e){var t=$("#prj-base-info-name").val(),a=$("#prj-base-info-desc").val(),n={title:SLCProjManage.currProj.title,desc:SLCProjManage.currProj.desc};if(!t)return void alert("标题不能为空!");SLCProjManage.currProj.title=t,SLCProjManage.currProj.desc=a;var i=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj);i&&0===i.err_code?(SLCProjManage.currProj=i.data,$("#project-tbl-id").DataTable().clear(),updateProjectInlist(SLCProjManage.currProj),projectTblAddRows(SLCProjManage.projs),$("#edit-prj-base-info-btn").attr("disabled",!1),$("#save-prj-base-info-btn").attr("disabled",!0),$("#prj-base-info-name").attr("readonly",!0),$("#prj-base-info-desc").attr("readonly",!0)):(SLCProjManage.currProj.title=n.title,SLCProjManage.currProj.desc=n.desc,alert("标题已被使用!"))}),$("#custom-link-add").click(function(){var e=getLinkBtnRow(),t=$("#links-tbl-id").DataTable();t.rows.add(e),t.draw(!1),e.find("span.edit").trigger("click")}),$("#custom-links-done").click(function(){function e(){var e=[],t=!0;if($("#links-tbl-id tbody tr").each(function(a,n){var i={ico:$(n).find(".ico").data("res_id"),title:$(n).find(".title").val(),content:$(n).find(".url").val()};return!!$(n).find(".ico-input").length&&(i.title&&i.content?void e.push(i):(t=!1,$(n).find("span.edit").trigger("click"),!1))}),!t)return void alert("标题和链接（或电话号码）都要求填写!");SLCProjManage.currProj.links=e;var a=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj);a&&0===a.err_code?(SLCProjManage.currProj=a.data,updateProjectInlist(SLCProjManage.currProj)):alert("设置失败!"),$("#custom-link-mdl").modal("hide")}var t={size:0,currtent:0,trigger:function(){t.currtent+=1,t.currtent==t.size&&n.upload()}},a=0,n=createUploadFileObj(e,t);$("#links-tbl-id tbody tr").each(function(e,i){if(!$(i).find(".ico-input").length)return!1;var r=$(i).find(".ico-input")[0].files;if(r.length){t.size+=1,a+=1;var o=r[0].name,l=o.lastIndexOf("."),c=o.substr(l);r[0].md5Identifier=r[0].md5+".original.original"+c,n.addFile(r[0]),$(i).find(".ico").data("res_id",r[0].md5)}}),a||e()}),$("#set-links").click(function(){showLinksModal()}),$("#custom-btn-add").click(function(){var e=getCustomBtnRow(),t=$("#btns-tbl-id").DataTable();t.rows.add(e),t.draw(!1),e.find("span.edit").trigger("click")}),$("#custom-btns-done").click(function(){function e(){var e=[];if(valid=!0,$("#btns-tbl-id tbody tr").each(function(t,a){if(!$(a).find(".ico-input").length)return!1;var n={ico:$(a).find(".ico").data("res_id"),title:$(a).find(".title").val(),content:$(a).find(".content").val()};return n.title&&n.content?void e.push(n):(valid=!1,$(a).find("span.edit").trigger("click"),!1)}),!valid)return void alert("标题和html内容都要求填写！");SLCProjManage.currProj.buttons=e;var t=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj);t&&0===t.err_code?(SLCProjManage.currProj=t.data,updateProjectInlist(SLCProjManage.currProj)):alert("设置失败!"),$("#custom-btn-mdl").modal("hide")}var t={size:0,currtent:0,trigger:function(){t.currtent+=1,t.currtent==t.size&&n.upload()}},a=0,n=createUploadFileObj(e,t);$("#btns-tbl-id tbody tr").each(function(e,i){if(!$(i).find(".ico-input").length)return!1;var r=$(i).find(".ico-input")[0].files;if(r.length){t.size+=1,a+=1;var o=r[0].name,l=o.lastIndexOf("."),c=o.substr(l);r[0].md5Identifier=r[0].md5+".original.original"+c,n.addFile(r[0]),$(i).find(".ico").data("res_id",r[0].md5)}}),a||e()}),$("#set-buttons").click(function(){showBtnsModal()}),$("#likeCheck").click(function(){var e=$("#likeCheck").is(":checked");changeCheckSetting("enable_like",e)}),$("#overlookCheck").click(function(){var e=$("#overlookCheck").is(":checked");changeCheckSetting("enable_overlook",e)}),$("#autorotationCheck").click(function(){var e=$("#autorotationCheck").is(":checked");changeCheckSetting("enable_autorotation",e)}),$("#autoDeviceOrientationCheck").click(function(){var e=$("#autoDeviceOrientationCheck").is(":checked");changeCheckSetting("enable_orientation",e)}),$("#vrCheck").click(function(){var e=$("#vrCheck").is(":checked");changeCheckSetting("enable_vr",e)}),$("#pano_link").on("shown.bs.tab",function(e){ShowPanoList()}),$("#material_link").on("shown.bs.tab",function(e){ShowMaterialList()}),$("#create-category").bind("click",function(){var e=$("#category-name").val();if(""==e)return void alert("名字不能为空");for(var t=$("#pano_pane")[0].tags,a=0;a<t.length;a++)if(t[a].name==e||t[a].title==e)return void alert("名字已被使用");var n={oorigin_id:"",category:"panorama",tags:[e]};addfileinfo(n),addCategoryTag(e,[]),$("#create-tag-mdl").modal("hide")});var onMaterialEditClick=function(){var e=!0;return function(){showPage("material-edit-page"),e&&(ShowPanoList(),e=!1)}}();$("#upload_material").click(function(e){$("#selectfile").val(""),$("#file_title").text("文件名"),$("#upload-file-mdl").modal({backdrop:!1,keyboard:!1})}),$("#upload-pano").click(function(e){$("#selectfile").val(""),$("#file_title").text("文件名"),$("#upload-file-mdl").modal({backdrop:!1,keyboard:!1})}),$("#upload_file").click(function(e){e.preventDefault(),$("#selectfile").trigger("click")}),$("#selectfile").change(function(e){var t=$("#selectfile")[0].files;t.length>0&&(fileMd5(t[0],null),$("#file_title").text(t[0].name))}),$("#fileDone").click(function(){function e(e){var t=(spinnerOpts(),$("#upload-file-mdl .modal-dialog button")),a=e.name,n=a.lastIndexOf("."),i=a.substr(n);e.md5Identifier=e.md5+".original.original"+i;var r=function(){t.each(function(){$(this).removeAttr("disabled")}),$("#upload-file-mdl").modal("hide");({oorigin_id:e.md5,category:"material"});addMaterialFileInfo(e.md5)},o={size:1,currtent:0,trigger:function(){l.upload()}};t.each(function(){$(this).attr("disabled",!0)});var l=createUploadFileObj(r,o,$("#upload-file-mdl .modal-dialog"));l.addFile(e)}function t(e){var t=$("#upload-file-mdl .modal-dialog button");t.each(function(){$(this).attr("disabled",!0)});var a=function(e){var a=e;return function(){t.each(function(){$(this).removeAttr("disabled")}),addPanoFileInfo(a),$("#upload-file-mdl").modal("hide")}}(e.md5),n=function(){t.each(function(){$(this).removeAttr("disabled")})};lrzImg(e,a,$("#upload-file-mdl .modal-dialog"),!1,n)}var a=$("#selectfile")[0].files;a&&0!=a.length&&($("#pano_link").closest("li").hasClass("active")?t(a[0]):$("#material_link").closest("li").hasClass("active")&&e(a[0]))}),$("#make_category").click(function(){$("#category-name").val(""),$("#create-tag-mdl").modal({keyboard:!1,backdrop:!1})}),$("#to-other-tag").click(function(){function e(e,t){for(var a=0;a<e.length;a++)e[a].tags=[t]}if($("#to-other-tag").attr("aria-expanded")){var t=$("#pano_pane")[0].tags,a=$("#catelog-list > li"),n=$("#to-other-tag").siblings("ul:first");if(n.empty(),n.unbind("click"),t.length<=1)return!1;for(var i='<li><a href="#">{title}</a></li>',r=0;r<t.length;r++){var o=$(i.format(t[r]));o.appendTo(n),a.eq(r).hasClass("active")&&o.hide()}n.bind("click",function(n){var i=$(a).index($("#catelog-list > .active")[0]);if(!(i<0)){var r=$(n.target).closest("li");if(0!=r.length){if(!t[i].pane.selected||0==t[i].pane.selected.length)return alert("请选择图片"),$("#to-other-tag").trigger("click"),!1;var o=r.index(),l=t[i].pane.selected,c=$(".is-show-unique",t[i].pane)[0].checked;return c&&(l=getSamePicFileInfos(t[i].pane.filelist,l)),t[i].pane.selected=[],e(l,t[o].name),updateFileinfo(l),addArrVals(t[o].data,l),removeArrVals(t[i].data,l),t[o].pane.update(!0),t[i].pane.update(!0),$("#to-other-tag").trigger("click"),!1}}})}}),$("#delete_pano").click(function(){event.stopPropagation();var e=$("#catelog-list > li").index($("#catelog-list > .active")[0]);if(!(e<0)){var t=$("#pano_pane")[0].tags;if(!t[e].pane.selected||0==t[e].pane.selected.length)return void alert("请选择图片");if(confirm("是否确认删除选中的"+t[e].pane.selected.length+"张图片")){var a=t[e].pane.selected;t[e].pane.selected=[];var n=$(".is-show-unique",t[e].pane)[0].checked;n&&(a=getSamePicFileInfos(t[e].pane.filelist,a)),deleteFileinfo(a),removeArrVals(t[e].data,a),t[e].pane.update(!0)}}}),$("#delete_material").click(function(){event.stopPropagation();var e=$("#material_pane")[0];if(!e.selected||0==e.selected.length)return void alert("请选择图片");if(confirm("是否确认删除选中的"+e.selected.length+"张图片")){var t=e.selected;e.selected=[];var a=$(".is-show-unique",e)[0].checked;a&&(t=getSamePicFileInfos(e.filelist,t)),deleteFileinfo(t),removeArrVals(e.filelist,t),e.update(!0)}}),$("#used-logo").click(function(e){var t=function(e){var t=$("#logo-title");""==t.val&&t.val(e.name),$("#file-logo")[0].files=null;var a=$("#logo-img-area");if(a.empty(),""!==e.oorigin_id){var n=new Image,i=ResourceMgr.find(e.oorigin_id);if(!i)return!1;$("#file-logo")[0].url=e.oorigin_id,n.crossOrigin="Anonymous",n.src=i[0].access_url,""==$("#logo-title").val()&&$("#logo-title").val(i[0].name),n.onload=adjustLogoImgSize,$(n).css("display","none"),a.append(n)}else a.append("<div>此项目没有设置对应的logo图标</div>")};SelectMaterial($("#logo-setting-mdl")[0],t,"image")}),$("#add-scene-group").click(function(){$("#create-group-mdl").modal({})}),$("#rename-mdl").on("shown.bs.modal",function(e){if(e.target===$("#rename-mdl").get(0)){var t=$("#rename-mdl").data("info");t&&(t.title||(t.title="重命名"),t.value||(t.value=""),$(".modal-title",$(this)).text(t.title),$("#rename-input",$(this)).val(t.value)),$("#rename-title").focus()}}),$("#rename-done").click(function(){var e=$("#rename-mdl").data("info");if(e&&e.callback){var t=e.callback($("#rename-input").val());if(!t)return}$("#rename-mdl").modal("hide")}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var t=$(e.target).attr("href");"#prj-scene-group-tab"==t?(initGroupInfo(),$('#prj-scene-group-tab .scene-group-content .nav-pills li a[href="#默认"]').first().trigger("click"),$("#group-scene-done").show()):$("#group-scene-done").hide()}),$("#create-group").click(function(){var e=$("#create-group-mdl #group-name").val();$("#create-group-mdl").modal("hide");var t=createGroupUi(e,[],!1,!1);t&&$("a",t).trigger("click")}),$("#group-add-scene").on("click",function(e){var t=$("#prj-scene-group-tab .scene-group-content .nav li.active").data("name");"默认"===t&&(alert("默认分组不能添加场景"),e.stopPropagation())}),$("#group-del-scene").click(function(){var e=$("#prj-scene-group-tab .scene-group-content .nav li.active").data("name");if("默认"===e)return void alert("默认分组不能删除场景");var t=$("#prj-scene-group-tab .add-group .dropdown-menu"),a=$("#prj-scene-group-tab #"+e+" .scene-img-area"),n=SLCProjManage.currProj.scenes;$(".img-cls.selected",a).each(function(e,a){var i=$(a).data("_id"),r=sceneIdxById(i,n);groupAddListItem(n[r]).appendTo(t),addImgView(i,$("#prj-scene-group-tab #默认 .scene-img-area"))}).remove()}),$("#group-scene-done").click(function(){var e=[];if($("#prj-scene-group-tab .tab-content .tab-pane").each(function(t,a){var n=$(a).attr("id");if("默认"!=n){var i={title:n,scenes:[]};$(".scene-img-area .img-cls",$(a)).each(function(e,t){i.scenes.push($(t).data("_id"))}),e.push(i)}}),SLCProjManage.currProj.scene_groups=e,res=SLCUtility.callFunc("POST","updateProject",SLCProjManage.currProj),res&&0===res.err_code){SLCProjManage.currProj=res.data;var t=$("#prj-scene-group-tab .scene-group-content .nav li.active").data("name");initGroupInfo(),$("#prj-scene-group-tab .scene-group-content .nav-pills li").each(function(e,a){t&&$(a).data("name")==t&&$("a",a).trigger("click")}),alert("分组修改成功!"),updateProjectInlist(SLCProjManage.currProj)}updateProjectResource()});