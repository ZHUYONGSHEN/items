function generateThumb(e,t,n){function i(t){e.resolve(t)}if(!SLCSceneSetting.bChangeThumb)return void e.resolve();SLCSceneSetting.bChangeThumb=!1;var a=document.createElement("canvas");a.width=t,a.height=n;var o=a.getContext("2d"),s=$("#visual-angle-preview-img").get(0);o.drawImage(s,0,0,t,n),gainCanvasBlob(a,i)}function updatePointTag(){var e=SLCSceneSetting.pano.getCurrScene();e.jump_tags=[],e.picture_tags=[],e.hyperlink_tags=[],e.voice_tags=[],e.introduce_tags=[],e.mark_tags=[];for(var t in SLCSceneSetting.pano.currScenePointMap){var n=SLCSceneSetting.pano.currScenePointMap[t];switch(n.type){case"jump":e.jump_tags.push(n.tag);break;case"hyperlink":e.hyperlink_tags.push(n.tag);break;case"voice":e.voice_tags.push(n.tag);break;case"introduce":e.introduce_tags.push(n.tag);break;case"picture":e.picture_tags.push(n.tag);break;case"mark":e.mark_tags.push(n.tag)}}}function updateScene(e){e&&(SLCSceneSetting.pano.getCurrScene().thumbnail_res_id=e,updateResourceFromIds([e])),updatePointTag();var t=SLCSceneSetting.pano.getCurrScene();console.log(t),$.ajax({url:backPath+"/pano/point/save",type:"POST",data:JSON.stringify(t),dataType:"json",contentType:"application/json;charset=utf-8",success:function(e,t,n){},error:function(e,t,n){}})}function SceneSetting(e,t){var n=[];0!==n.length&&$.ajax({type:"post",data:JSON.stringify(n),url:"/api/getFiles",success:function(e){var t=e.data;validResMap(t,resources)},async:!1}),null===SLCSceneSetting.pano&&(SLCSceneSetting.pano=new Panorama("container"),SLCSceneSetting.pano.ready=!0,SLCSceneSetting.pano.AddLoadFilishEvent(loadAllPoint(SLCSceneSetting.pano))),SLCSceneSetting.pano.reset(e);var i=SLCSceneSetting.pano.project.scenesIndexMap,a=i[t];SLCSceneSetting.pano.loadScene(a),SLCSceneSetting.pano.isScenesEdit=!0;var o=SLCSceneSetting.pano.project.scenes[a],s=SLCSceneSetting.pano.project.id,c=s+"_"+o.id;SLCSceneSetting.editPoints&&c in SLCSceneSetting.editPoints&&(SLCSceneSetting.pano.currScenePointMap=SLCSceneSetting.editPoints[c],delete SLCSceneSetting.editPoints[c])}function clearCurrScene(){$('a[href="#visual-angle-initial"]').tab("show"),$("#visual-angle-pane").hide(),$(".visual-angle-frome").hide(),$("#hot-point-item-container").hide(),$(".hot-point-page-btn").removeClass("selected"),SLCSceneSetting.bNeedChangePreviewImg=!0,SLCSceneSetting.fovSlideObj&&(SLCSceneSetting.fovSlideObj.releaseObj(),SLCSceneSetting.fovSlideObj=null),SLCSceneSetting.vertialSlideObj&&(SLCSceneSetting.vertialSlideObj.releaseObj(),SLCSceneSetting.vertialSlideObj=null),showSetttingPane("")}function showPhotoFrome(e,t){if(!(e<250||t<150)){var n=600,i=350;e/t>1.75?t<400&&(i=t-50,n=600*i/350):e<700&&(n=e-100,i=350*n/600),$(".visual-angle-frome").css({top:(t-i)/2,left:(e-n)/2,width:n,height:i}),$(".visual-angle-frome").show()}}function generatePreviewImg(){if(SLCSceneSetting.bNeedChangePreviewImg!==!1){SLCSceneSetting.bChangeThumb=!0,SLCSceneSetting.bNeedChangePreviewImg=!1;var e=$("#"+SLCSceneSetting.pano.containerId).children("canvas")[0],t=e.toDataURL("image/jpeg",.5);$("#visual-angle-preview-img").attr("src",t)}}function DrogObj(e,t,n,i,a,o,s){this.minX=n,this.maxX=i;var c,d=!1,l=$(e),r=this;s&&(t+=6),l.css("left",t),this.onMousedown=function(e){c=e.pageX-(parseInt(l.css("left"))||0),l.css("cursor","move").fadeTo(20,.5),d=!0},this.onMouseup=function(e){d&&(d=!1,l.fadeTo(20,1))},this.onMousemove=function(e){if(d){var t=e.pageX-c;t=Math.round(t/a)*a,t=Math.max(t,r.minX),t=Math.min(t,r.maxX),parseInt(l.css("left"))!==t&&(s?l.css({left:t+6}):l.css({left:t}),o&&o(t))}},this.addEvent=function(){l.bind("mousedown",this.onMousedown),l.bind("mouseup",this.onMouseup),$(document).bind("mousemove",this.onMousemove),$(document).bind("mouseup",this.onMouseup)},this.removeEvent=function(){l.unbind("mousedown",this.onMousedown),l.unbind("mouseup",this.onMouseup),$(document).unbind("mousemove",this.onMousemove),$(document).unbind("mouseup",this.onMouseup)},this.releaseObj=function(){this.removeEvent()},this.addEvent()}function MySlideObj(e,t,n,i,a,o,s){function c(e){return Math.round(i*e/v)+n}function d(e){return(e-n)/i*v}var l=this,r=$(e),u=parseInt(r.children(".slide-area-line").width()),p=Math.abs(Math.ceil((t-n)/i)),v=u/p;this.onMinChange=function(e){if(l.currObj.minX=e,l.minValueChange){var t=c(e);l.minValueChange(t)}},this.onMaxChange=function(e){if(l.currObj.maxX=e,l.maxValueChange){var n=t;e<u&&(n=c(e)),l.maxValueChange(n)}},this.onCurrChange=function(e){if(l.minObj.maxX=e,l.maxObj.minX=e,l.currValueChange){var n=t;e<u&&(n=c(e)),l.currValueChange(n)}};var m=d(s),g=Math.min(d(a),u),f=d(o),h=r.children(".top-slide-area").children(".curr-value-slide-body"),b=r.children(".bottom-slide-area").children(".max-value-slide-body"),S=r.children(".bottom-slide-area").children(".min-value-slide-body");this.currObj=new DrogObj(h,m,f,g,v,this.onCurrChange),this.maxObj=new DrogObj(b,g,f,u,v,this.onMaxChange,!0),this.minObj=new DrogObj(S,f,0,m,v,this.onMinChange),this.releaseObj=function(){this.currObj.releaseObj(),this.maxObj.releaseObj(),this.minObj.releaseObj()}}function adjustScenePointsPos(e,t,n){function i(e){var t=new THREE.Vector3(0,0,-1);return t.applyMatrix4(e.matrixWorld),t}function a(e,t){$(e.elem).css({"-webkit-transform":"rotate("+t+"deg)","-moz-transform":"rotate("+t+"deg)","-ms-transform":"rotate("+t+"deg)","-o-transform":"rotate("+t+"deg)",transform:"rotate("+t+"deg)"}),e.fakeItem&&$(e.fakeItem.elem).css({"-webkit-transform":"rotate("+t+"deg)","-moz-transform":"rotate("+t+"deg)","-ms-transform":"rotate("+t+"deg)","-o-transform":"rotate("+t+"deg)",transform:"rotate("+t+"deg)"})}function o(t,n){n.dirty=!1;var a=$(n.elem),o=n.position(),s=(t.target||i(t),new THREE.Vector3(o.x,o.y,o.z)),c=e.vec3toVec2(t,s),d=a.data("width"),l=a.data("height");"number"==typeof r&&"number"==typeof u||(d=a.width(),l=a.height(),a.data("width",d),a.data("height",l)),c.x-=d/2,c.y-=l/2,a.show();var r=a.data("left"),u=a.data("top"),p={left:r,top:u};if("number"==typeof r&&"number"==typeof u||(p=a.position()),Math.abs(p.left-c.x)>1||Math.abs(p.top-c.y)>1){a.offset();a.css({top:c.y,left:c.x}),a.data("left",c.x),a.data("top",c.y)}return a.hide().show(0),!0}if(void 0===t)return!1;for(var s=!1,c=0;c<t.length;c++){if(e.vrMode||e.project.enable_orientation){var d=horizontalRotateAngle();a(t[c],d)}else a(t[c],0);if("fix"!=t[c].mode&&!t[c].onDragStat()&&(n||t[c].dirty)&&!$(t[c].elem).hasClass("vr-hide")){var l=e.vrMode?e.vrRenderer.stereo.cameraL:e.camera;if(s|=o(l,t[c]),e.vrMode){e.getViewSize();s|=o(e.vrRenderer.stereo.cameraR,gainFakeRightItem(t[c]))}}}return s}var project,pro,resources;window.parent.document.body.onmousewheel=null,$.get(siteRoot+"/pano/"+albumId,function(e){SceneSetting(e,sceneId);var t=SLCSceneSetting.pano.getCurrScene();t.visual_angle.init_point;window.addEventListener("message",function(e){},!1)}),SLCSceneSetting={bNeedChangePreviewImg:!0,bChangeThumb:!1,fovSlideObj:null,vertialSlideObj:null,pano:null},$(function(){$("body").width(document.documentElement.clientWidth),$("body").height(document.documentElement.clientHeight),$(window).resize(function(e){$("body").width(document.documentElement.clientWidth),$("body").height(document.documentElement.clientHeight)})}),$("#main-close-btn").click(function(e){var t=SLCSceneSetting.pano.getCurrScene().id;SLCSceneSetting.editPoints||(SLCSceneSetting.editPoints={});var n=SLCSceneSetting.pano.project.id;SLCSceneSetting.editPoints[n+"_"+t]=SLCSceneSetting.pano.currScenePointMap,window.parent.document.getElementById("point_setting").style.display="none",window.parent.document.getElementsByClassName("mask")[0].style.display="none",window.parent.document.body.style.overflow="initial"}),$("#main-save-btn").click(function(e){function t(){c.stop(),$("#mask").css("display","none");var e=SLCSceneSetting.pano.project.id,t=e+"_"+SLCSceneSetting.pano.getCurrScene().id;SLCSceneSetting.editPoints&&t in SLCSceneSetting.editPoints&&(SLCSceneSetting.pano.currScenePointMap=SLCSceneSetting.editPoints[t],delete SLCSceneSetting.editPoints[t]),$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>保存成功!</div><div class='foot'><button class='btn3'>确定</button></div></div>")}var n=jQuery.Deferred(),i=jQuery.Deferred(),a=jQuery.Deferred(),o=spinnerOpts(),s=$("body:first"),c=new Spinner(o).spin(s.get(0));$("#mask").css("display","block");var d=SLCSceneSetting.pano.getCurrScene();try{n.done(function(e){getBlobMd5(a,e)}),a.done(function(e,t){uploadBlob(i,e,t,d.name)}),i.done(updateScene).done(t)}catch(e){t(),window.console("update scene error")}generateThumb(n,256,128)});var showSetttingPane=function(){var e={"visual-angle-pane":{showDone:function(){$('a[href="#visual-angle-initial"]').click(),showPhotoFrome(document.documentElement.clientWidth,document.documentElement.clientHeight),generatePreviewImg()},hideDone:function(){$(".visual-angle-frome").hide()}},"hot-point-pane":{showDone:function(){},hideDone:function(){}}};return function(t){for(var n in e)0!=e.hasOwnProperty(n)&&(t===n?$("#"+n).show({complete:e[n].showDone}):$("#"+n).hide({complete:e[n].hideDone}))}}();$("#main-visual-angle-btn").click(function(e){var t=SLCSceneSetting.pano;null!==t&&(initVisualAngle(t.getCurrScene().visual_angle),showSetttingPane("visual-angle-pane"))}),$('a[href="#visual-angle-initial"]').on("shown.bs.tab",function(e){showPhotoFrome(document.documentElement.clientWidth,document.documentElement.clientHeight)}),$('a[href="#visual-angle-fov"]').on("shown.bs.tab",function(e){if(null==SLCSceneSetting.fovSlideObj){var t=SLCSceneSetting.pano.getCurrScene().visual_angle,n=t.max_fov,i=t.min_fov,a=t.init_fov,o=new MySlideObj($("#fov-value-slide"),cameraMaxFov,cameraMinFov,1,n,i,a);o.maxValueChange=function(e){$("#fov-value-max")[0].innerHTML=e,t.max_fov=e},o.minValueChange=function(e){$("#fov-value-min")[0].innerHTML=e,t.min_fov=e},o.currValueChange=function(e){$("#fov-value-init")[0].innerHTML=e,t.init_fov=e,SLCSceneSetting.pano.camera.fov=e,SLCSceneSetting.pano.camera.updateProjectionMatrix()},$("#fov-value-max")[0].innerHTML=n,$("#fov-value-min")[0].innerHTML=i,$("#fov-value-init")[0].innerHTML=a,SLCSceneSetting.fovSlideObj=o}}),$('a[href="#visual-angle-vertical"]').on("shown.bs.tab",function(e){if(a=SLCSceneSetting.pano.lat,null==SLCSceneSetting.vertialSlideObj){var t=SLCSceneSetting.pano.getCurrScene().visual_angle,n=t.max_angle,i=t.min_angle,a=SLCSceneSetting.pano.camera.rotation.x;a=THREE.Math.radToDeg(a);var o=new MySlideObj($("#visual-angle-vertical-slide"),90,-90,1,n,i,a);o.maxValueChange=function(e){$("#visual-angle-vertical-max")[0].innerHTML=e,t.max_angle=e},o.minValueChange=function(e){$("#visual-angle-vertical-min")[0].innerHTML=e,t.min_angle=e},o.currValueChange=function(e){SLCSceneSetting.pano.camera.rotation.x=THREE.Math.degToRad(e);var t=SLCSceneSetting.pano.getCurrScene();if(!t.pos_seted){var n=t.visual_angle.init_point;n.x=SLCSceneSetting.pano.camera.target.x,n.y=SLCSceneSetting.pano.camera.target.y,n.z=SLCSceneSetting.pano.camera.target.z}SLCSceneSetting.pano.bIsChanged=!0},$("#visual-angle-vertical-max")[0].innerHTML=n,$("#visual-angle-vertical-min")[0].innerHTML=i,SLCSceneSetting.vertialSlideObj=o}}),$('a[href="#visual-angle-initial"]').on("hide.bs.tab",function(e){$(".visual-angle-frome").hide()}),$(".visual-angle-btn").click(function(e){e.stopPropagation(),e.preventDefault(),SLCSceneSetting.pano.getCurrScene().visual_angle.init_point={x:SLCSceneSetting.pano.camera.target.x,y:SLCSceneSetting.pano.camera.target.y,z:SLCSceneSetting.pano.camera.target.z},SLCSceneSetting.bNeedChangePreviewImg=!0,generatePreviewImg();var t=SLCSceneSetting.pano.getCurrScene();t.pos_seted=!0}),function(){function e(){var e=$("#target-scene-adm");e.empty();for(var t=SLCSceneSetting.pano.project.scenes,n=0;n<t.length;n++){var i=t[n],a=$.parseHTML('<div class="select-scene-item" data-scene-id="'+i.id+'">                     <img crossorigin="Anonymous" src="'+i.thumbnailUrl+'"/>                     <div>'+i.name+"</div>                 </div>");e.append(a)}}function t(e,t,n){$(e).css("display","none"),e.src=t,e.onload=function(e){var t=e||window.event,i=t.target;if(!n||0!=n(i)){var a=getImageRelativeSize(i.width,i.height,860,320);i.width=a.w,i.height=a.h,$(i).css("display","")}}}function n(e,t,n){var i=e.getItemName(),a=e.getDescription();p=0,$(".hot-point-item-elems").remove();var o=$("#hot-point-item-container-info"),s=$('<div class="hot-point-item-elems"></div>');for(var c in t)if(0!=t.hasOwnProperty(c))if(t[c].type==n){p+=1;var d=t[c].tag,l=ResourceMgr.decodeRes(d.res_id);l||(l=d.res_id);var r=$.parseHTML('<div class="hot-point-item" data-index="'+c+'">                                     <img crossorigin="Anonymous" src="'+l+'" />                                     <p>'+d.name+" </p>                                  </div>");s.append(r),t[c].edit_item=r[0]}else t[c].edit_item=null;o.append(s),$("#hot-point-item-info").html("已添加"+p+"个"+i+"热点"),$("#hot-point-item-description").html(a)}function i(e,t,n){if(e){var i=null;n in e&&(i=e[n]),m=e[t],i&&m.type==i.type||$('.hot-point-page-btn[data-type="'+m.type+'"]').click(),i&&($(i.div_item).css({opacity:.5}),i.edit_item&&$(i.edit_item).css({"border-color":""}),i.secen_item.setMode("display")),$(m.div_item).css({opacity:1}),m.edit_item&&$(m.edit_item).css({"border-color":"#00a3d8"}),m.secen_item.setMode("edit")}}function a(e,t){var i={type:e,tag:t},a=SLCUtility.getHtmlId();SLCSceneSetting.pano.currScenePointMap[a]=i;var o=createPointImg(i,!0,a,SLCSceneSetting.pano);return $(o).css({opacity:1}),n(A[e],L,e),a}function o(e,t,n,i,a){var o=$("#add-point-select-file-pane");o.empty();for(var s=t;s<e.length&&s<t+n;s++){var c=e[s],d=c.oorigin_id,l=ResourceMgr.find(d),r=ResourceMgr.decodeRes(d);if(l&&0!=l.length&&r){var u=l[0].name,p=$.parseHTML('<div class="add-point-file-item" data-res-id="'+d+'">                             <img crossorigin="Anonymous" src="'+r+'" />                             <div class="select-file-title">'+u+"</div>                         </div>");o.append(p)}}var v="";v+=Math.ceil(t/n)+1,v+="/",v+=Math.ceil(e.length/n);var m=$.parseHTML('<div class="add-point-file-page-ctrl">                                         <button id="add-point-file-pre">上一页</button>                                         <span>'+v+'</span>                                         <button id="add-point-file-next">下一页</button>                                     </div>');o.append(m),$("#add-point-file-pre").click(i),$("#add-point-file-next").click(a)}function s(){var e=getFileList("material");validFileInfoResource(e,0,e.length);for(var t=e.length-1;t>=0;t--){var n=e[t],i=ResourceMgr.find(n.oorigin_id);(!i||i[0].file_type.indexOf("image")<0)&&e.splice(t,1)}return e}function c(){var e=s(),t=10,n=0,i=function(){n+t>e.length||(n+=10,o(e,n,t,a,i))},a=function(){n-t<0||(n-=10,o(e,n,t,a,i))};o(e,n,t,a,i)}function d(e,t){var n=ResourceMgr.decodeRes(t);n||(n=t),$(e.div_item).children("img").attr("src",n),$(e.edit_item).children("img").attr("src",n),$(e.edit_item).children("p").html(e.tag.name),$("p",e.div_item).html(e.tag.name)}function l(e){e?($("#add-point-centent-pane").hide(),$("#add-point-select-file-pane").show(),O=!0,$("#cancel-add-point-btn").html("返回")):($("#add-point-centent-pane").show(),$("#add-point-select-file-pane").hide(),O=!1,$("#cancel-add-point-btn").html("取消"))}function r(e){function t(e){var i=myPano.camera.fov;if(i==d&&p>=1)return myPano.overLooking=!1,myPano.controls.play(),void myPano.loadScene(n);if(p<1){var a=30;if(r&&Math.abs((s-myPano.lon)%360/r)>e){var c=new THREE.Quaternion;c.setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(r*e)),myPano.camera.quaternion.multiply(c)}if(u&&Math.abs((o-myPano.lat)/u)>e){var v=new THREE.Quaternion;v.setFromAxisAngle(new THREE.Vector3(1,0,0),THREE.Math.degToRad(u*e)),myPano.camera.quaternion.multiply(v)}p+=e,p>=1&&(a=600,e=.01,p=1),window.setTimeout(t,a,e+.005)}else i!=d&&(i-=e*l,i<d&&(i=d),myPano.camera.fov=i);myPano.bIsChanged=!0,myPano.camera.updateProjectionMatrix()}var n=myPano.getSceneIndex(e.tag.scene_id),i=e.secen_item.position(),a=window.xyz2latlon(i.x,i.y,i.z,500),o=a.lat,s=a.lon,c=e.secen_item.position(),d=c.minFov?c.minFov:20,l=myPano.camera.fov-d,r=(s-myPano.lon)%360;r>180?(s-=360,r-=360):r<-180&&(s+=360,r+=360);r=Math.round(100*r)/100;var u=Math.round(100*(o-myPano.lat))/100,p=0;myPano.controls.pause(),t(.04)}var u=function(){var e=!1,t=cosAccessHost+"/material/sys/pano/point/",n=[t+"front.gif",t+"down.gif",t+"left.gif",t+"left-up.gif",t+"right.gif",t+"right-up.gif",t+"touch.gif",t+"position.gif",t+"position2.gif",t+"reading-glass.gif",t+"add.gif",t+"airplane.gif"],i=[t+"position.gif",t+"position2.gif",t+"reading-glass.gif",t+"add.gif",t+"airplane.gif"];return function(){if(!e){e=!0;for(var t=0;t<n.length;t++){var a=n[t];$(".select-icon-container").append('<img crossorigin="Anonymous" class="icon-img-item" src="'+a+'" data-res-id="'+a+'">')}for(var o=0;o<i.length;o++){var a=i[o];$(".select-icon-container-mark").append('<img crossorigin="Anonymous" class="icon-img-item" src="'+a+'" data-res-id="'+a+'">')}}}}();$("#hot-point-item-container").on("mouseenter",".hot-point-item",function(){$("#hot-point-item-controls").css({display:"block"})});var p,v,m="",g="",f="",h="",b="",S="",y="",k=null,C="",_=null,w=null,M=0,L=null,x=null,P="",O=!1,j="",T=null,E="",I=!1,R=function(){var e=['a[href="#target-scene-adm"]','a[href="#hyperlink-addr-adm"]','a[href="#select-picture-adm"]','a[href="#add-text-adm"]','a[href="#select-music-adm"]','a[href="#add-mark-adm"]'];return function(t){for(var n=0;n<e.length;n++)t==e[n]?$(e[n]).parent().show():$(e[n]).parent().hide()}}(),A={jump:{showEvent:function(){if(R('a[href="#target-scene-adm"]'),e(),""!==P){var t=L[P];C=t.tag.res_id,$(".select-scene-item").each(function(){if($(this).attr("data-scene-id")==t.tag.scene_id)return $(this).click(),!1})}},doneEvent:function(){if(""===C||""===y)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标和需要跳转的场景!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;var e=SLCSceneSetting.pano.project.scenesIndexMap[y],t=SLCSceneSetting.pano.project.scenes[e].name;if(f=P,""===P){var n={titleShow:!0,point:null,res_id:C,name:t,scene_id:y};w.jump_tags.push(n),f=a("jump",n)}else h=L[P],h.tag.name=t,h.tag.scene_id=y,h.tag.res_id=C,h.tag.titleShow=!0,d(h,C);return i(L,f,M),M=f,!0},getPointTags:function(){return w.jump_tags},getItemName:function(){return"全景切换"},getDescription:function(){return"在全景中加入一个可以跳转到其它景点的热点"}},hyperlink:{showEvent:function(){if(""===P)$("#hyperlink-name").val(""),$("#hyperlink-url").val(""),$("#hyperlink-checkbox").attr("checked",!0);else{var e=L[P].tag;C=e.res_id,$("#hyperlink-name").val(e.name),$("#hyperlink-url").val(e.link_url),$("#hyperlink-checkbox").attr("checked",e.new_target)}R('a[href="#hyperlink-addr-adm"]')},doneEvent:function(){var e=$("#hyperlink-name").val(),t=$("#hyperlink-url").val(),n=/^http/gi,o=$("#hyperlink-checkbox").is(":checked");if(""===C||""===e||""===t)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标和需要跳转的超链接信息!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!validPointtitle(e))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>标题中汉字字符不能超过10个，英文字符不能超过20个。</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!t.match(n))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请以http://或者https://开头!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(f=P,b=$("#hyperlink-title-select").is(":checked"),""===P){var s={titleShow:b,point:null,res_id:C,name:e,link_url:t,new_target:o};console.log(s),w.hyperlink_tags.push(s),f=a("hyperlink",s)}else h=L[P],h.tag.name=e,h.tag.res_id=C,h.tag.link_url=t,h.tag.new_target=o,h.tag.titleShow=b,d(h,C);return i(L,f,M),M=f,!0},getPointTags:function(){return w.hyperlink_tags},getItemName:function(){return"超链接"},getDescription:function(){return"在全景中加入一个可以跳转到网页的热点"}},introduce:{showEvent:function(){if(""===P)$("#title-introduce-input").val(""),$("#content-introduce-input").val("");else{var e=L[P].tag;C=e.res_id,$("#title-introduce-input").val(e.name),$("#content-introduce-input").val(e.content)}R('a[href="#add-text-adm"]')},doneEvent:function(){var e=$("#title-introduce-input").val(),t=$("#content-introduce-input").val();if(""===C||""===e||""===t)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标，填写描述的标题和内容</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!validPointtitle(e))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>标题中汉字字符不能超过10个，英文字符不能超过20个。</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(f=P,b=$("#introduce-title-select").is(":checked"),""===P){var n={titleShow:b,point:null,res_id:C,name:e,content:t};w.introduce_tags.push(n),w.introduce_tags,f=a("introduce",n)}else h=L[P],h.tag.res_id=C,h.tag.name=e,h.tag.content=t,h.tag.titleShow=b,d(h,C);return console.log(f),console.log(n),console.log(h),i(L,f,M),M=f,!0},getPointTags:function(){return w.introduce_tags},getItemName:function(){return"文字内容"},getDescription:function(){return"在全景中加入一个可以描述当前信息的热点"}},picture:{showEvent:function(){if(""!==P){var e=L[P];C=e.tag.res_id,j=e.tag.other_res_id,$("#picture-title-adm").val(e.tag.name);var n=$(".select-picture-img-area");n.empty();var i=new Image;$(i).attr("crossorigin","Anonymous"),t(i,e.tag.other_res_id),n.append(i).append("<div class='img-mask'>删除</div>").css("display","block")}R('a[href="#select-picture-adm"]')},doneEvent:function(){var e=$("#picture-title-adm").val();if(""===C||""===e||!x&&""===j)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标，图片标题和对应的图片文件</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!validPointtitle(e))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>标题中汉字字符不能超过10个，英文字符不能超过20个。</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;f=P,b=$("#picture-title-select").is(":checked");var t=j;if(""===t&&(t=x.md5),""===P){var n={titleShow:b,point:null,res_id:C,name:e,other_res_id:t};w.picture_tags.push(n),f=a("picture",n)}else h=L[P],h.tag.res_id=C,h.tag.name=e,h.tag.other_res_id=t,h.tag.titleShow=b,d(h,C);return i(L,f,M),M=f,!0},getPointTags:function(){return w.picture_tags},getItemName:function(){return"图片浏览"},getDescription:function(){return"在全景中加入一个可以显示图片的热点"}},voice:{showEvent:function(){if(""!==P){var e=L[P];C=e.tag.res_id,$("#music-title-adm").val(e.tag.name);var t=$("#point-muisc-player").get(0);t.pause(),t.src=e.tag.other_res_id}R('a[href="#select-music-adm"]')},doneEvent:function(){var e=$("#music-title-adm").val(),t=null;if(x)t=x.md5;else if(""!==P){var n=L[P];t=n.tag.other_res_id}if(""===C||""===e)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标，音乐标题和对应的音乐文件</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!validPointtitle(e))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>标题中汉字字符不能超过10个，英文字符不能超过20个。</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(f=P,b=$("#music-title-select").is(":checked"),""===P){var o={titleShow:b,point:null,res_id:C,name:e,other_res_id:j};w.voice_tags.push(o),f=a("voice",o)}else n=L[P],n.tag.res_id=C,n.tag.name=e,n.tag.titleShow=b,n.tag.other_res_id=j,d(n,C);return i(L,f,M),M=f,!0},getPointTags:function(){return w.voice_tags},getItemName:function(){return"音频"},getDescription:function(){return"在全景中加入一个可以播放语音的热点"}},mark:{showEvent:function(){if($('.hot-point-page-btn[data-type="mark"]').is(".selected")&&($(".select-icon-container").hide(),$(".select-icon-container-mark").show()),""===P)$("#title-mark-input").val("");else{var e=L[P].tag;C=e.res_id,$("#title-mark-input").val(e.name)}R('a[href="#add-mark-adm"]')},doneEvent:function(){var e=$("#title-mark-input").val();if(""===C||""===e)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择显示的图标，填写描述的标题</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(!validPointtitle(e))return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>标题中汉字字符不能超过10个，英文字符不能超过20个。</div><div class='foot'><button class='btn3'>确定</button></div></div>"),!1;if(f=P,""===P){var t={titleShow:!0,point:null,res_id:C,name:e};console.log(w),w.mark_tags.push(t),w.mark_tags,f=a("mark",t)}else h=L[P],h.tag.res_id=C,h.tag.name=e,h.tag.titleShow=!0,d(h,C);return console.log(f),console.log(t),console.log(h),i(L,f,M),M=f,!0},getPointTags:function(){return w.mark_tags},getItemName:function(){return"文字内容"},getDescription:function(){return"在全景中加入一个可以描述当前信息的热点"}}};$("#main-hot-point-btn").click(function(e){w=SLCSceneSetting.pano.getCurrScene(),L=SLCSceneSetting.pano.currScenePointMap,console.log(w),showSetttingPane("hot-point-pane")}),$("#add-point-mdl").on("hidden.bs.modal",function(e){y="",k=null,P="",C="",j="",$(".select-picture-img-area").empty(),$("#picture-title-adm").val(""),T&&(T.css("border","none"),T=null),_&&($(_).css("border","none"),_=null),x=null,$(".tab-content").find("div").eq(v).find(".common-select").attr("checked",!1),$("#lastStep").css("display","none"),$("#select-material-btn").removeAttr("checked"),$("#myTab a").css({background:"#494A50"}),$("#point-muisc-player").get(0).pause(),$("#point-muisc-player-btn").html("试听"),$("#music-title-adm").val("")}).on("show.bs.modal",function(e){if(l(!1),u(),$('a[href="#select-icon-adm"]').tab("show"),$(".common-select").attr("checked","checked"),$(".select-icon-container").show(),$(".select-material-container").hide(),$("#select-sys-btn").attr("checked",!0),$("#save-add-point-btn").css({display:"none"}),$("#nextStep").css({display:"block"}),$("#myTab>li").eq(0).children(0).css({background:"#11B2E7"}),$("#nextStep").attr("disabled",!0),$("#save-add-point-btn").attr("disabled",!0),$("#nextStep").click(function(){$("#lastStep").css("display","block"),$("#myTab>li").eq(v).find("a").tab("show"),$("#myTab>li").eq(v).children().eq(0).css({background:"#00A3D8"}),$("#myTab>li").eq(0).children().eq(0).css({background:"#494A50"}),$("#nextStep").css({display:"none"}),$("#save-add-point-btn").css({display:"block"})}),$("#lastStep").click(function(){$(this).css("display","none"),$("#myTab>li").eq(0).find("a").tab("show"),$("#myTab>li").eq(v).children().eq(0).css({background:"#494A50"}),$("#myTab>li").eq(0).children().eq(0).css({background:"#00A3D8"}),$("#nextStep").css({display:"block"}),$("#save-add-point-btn").css({display:"none"})}),S in A){var t=A[S];t.showEvent(),$("#add-point-mdl-title").html("添加"+t.getItemName()+"热点")}}),$(".select-icon-container").on("click",".icon-img-item",function(e){$("#nextStep").removeAttr("disabled"),e.target!=_&&(C=$(e.target).attr("data-res-id"),$(e.target).css("border","2px solid #8C5B32"),_&&$(_).css("border",""),_=e.target)}),$(".select-icon-container-mark").on("click",".icon-img-item",function(e){$("#nextStep").removeAttr("disabled"),e.target!=_&&(C=$(e.target).attr("data-res-id"),$(e.target).css("border","2px solid #8C5B32"),_&&$(_).css("border",""),_=e.target)}),$("#target-scene-adm").on("click",".select-scene-item",function(e){var t=$(e.target);$("#save-add-point-btn").removeAttr("disabled"),0==t.hasClass("select-scene-item")&&(t=t.parent(".select-scene-item"));var n=t.attr("data-scene-id");n&&(t.css("border-color","#8C5B32").siblings().css("border-color",""),k=t,y=n)}),$(".hot-point-page-btn").click(function(e){v=$(this).index();var t=$(e.target).attr("data-type");(t!==S||$("#hot-point-item-container").is(":hidden"))&&(""!=S&&$('.hot-point-page-btn[data-type="'+S+'"]').removeClass("selected"),S=t,$("#hot-point-item-container").hide({duration:400,queue:!0,complete:function(){var e=A[S],t=SLCSceneSetting.pano.currScenePointMap;n(e,t,S)}}).show({duration:400,queue:!0,complete:function(){m=L[M],$("#hot-point-item-controls").css("display","none"),m&&m.type==S&&m.edit_item&&$(m.edit_item).css({"border-color":"#00a3d8"})}}),$('.hot-point-page-btn[data-type="'+S+'"]').addClass("selected"))}),$("#location").on("click",function(){"undefined"==typeof m?$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"):"rgb(0, 163, 216)"==$(m.edit_item).css("border-color")?r(m):$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>")}),$("#delete").on("click",function(e){"undefined"==typeof m?$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"):"rgb(0, 163, 216)"==$(m.edit_item).css("border-color")?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>确定删除?</div><div class='foot'><button class='btn1'>确定</button><button class='btn2'>取消</button></div></div>"),$("#alertMask").on("click",".btn2",function(){$("#alertMask").css("display","none"),$(".yesOrno").css("display","none")}),$("#alertMask").on("click",".btn1",function(){function t(e,t){for(var n=0;n<e.length;n++)if(e[n]==t){e.splice(n,1);break}}SLCSceneSetting.pano.removePointItem(h.secen_item),$(h.div_item).remove(),t(w.jump_tags,h.tag),t(w.hyperlink_tags,h.tag),t(w.introduce_tags,h.tag),t(w.picture_tags,h.tag),t(w.voice_tags,h.tag),t(w.mark_tags,h.tag),delete L[f],n(A[S],L,S),0==p&&$("#hot-point-item-controls").css("display","none"),e.stopPropagation(),$("#alertMask").css("display","none"),$(".yesOrno").css("display","none"),h="",f="",m=""})):$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>")}),$("#edit-title").on("click",function(e){"rgb(0, 163, 216)"!=$(".hot-point-item").css("border-color")&&$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>")}),$("#edit-content").on("click",function(e){"rgb(0, 163, 216)"!=$(".hot-point-item").css("border-color")&&$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>")}),$("#hot-point-item-container-info").on("click",".hot-point-item",function(e){g=$(this).index();var t=$(e.target);0==t.hasClass("hot-point-item")&&(t=t.parent(".hot-point-item")),f=t.attr("data-index"),h=L[f],i(L,f,M),M=f,h.secen_item.gotoItem(),$("#edit-title").off().on("click",function(e){return P=t.attr("data-index"),"undefined"==typeof L[P]?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),P="",""):($("#add-point-mdl").modal(),$("#save-add-point-btn").removeAttr("disabled"),$("#lastStep").css("display","none"),void e.stopPropagation())}),$("#edit-content").off().on("click",function(e){return P=t.attr("data-index"),"undefined"==typeof L[P]?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),
P="",""):($("#add-point-mdl").modal(),$("#save-add-point-btn").css("display","block"),$("#save-add-point-btn").removeAttr("disabled"),$("#lastStep").css("display","block"),$("#nextStep").css("display","none"),$("#myTab>li").eq(v).find("a").css({background:"#00A3D8"}),$("#myTab>li").eq(0).find("a").css({background:"#45454F"}),$("#myTab>li").eq(v).find("a").tab("show"),void e.stopPropagation())})}).on("click",".hot-point-item-edit",function(e){var t=$(e.target);0==t.hasClass("hot-point-item")&&(t=t.parent(".hot-point-item")),P=t.attr("data-index"),$("#add-point-mdl").modal(),e.stopPropagation()}),$("#container").on("click",".hot-point-tag-item",function(e){var t=$(e.target);0==t.hasClass("hot-point-tag-item")&&(t=t.parent(".hot-point-tag-item")),f=t.attr("data-index"),f!=M&&L&&(h=L[f],i(L,f,M),M=f,$("#edit-title").off().on("click",function(e){return P=t.attr("data-index"),"undefined"==typeof L[P]?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),P="",""):($("#add-point-mdl").modal(),$("#save-add-point-btn").removeAttr("disabled"),$("#lastStep").css("display","none"),void e.stopPropagation())}),$("#edit-content").off().on("click",function(e){return P=t.attr("data-index"),"undefined"==typeof L[P]?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请先选择热点!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),P="",""):($("#add-point-mdl").modal(),$("#save-add-point-btn").css("display","block"),$("#save-add-point-btn").removeAttr("disabled"),$("#lastStep").css("display","block"),$("#nextStep").css("display","none"),$("#myTab>li").eq(v).find("a").css({background:"#00A3D8"}),$("#myTab>li").eq(0).find("a").css({background:"#45454F"}),$("#myTab>li").eq(v).find("a").tab("show"),void e.stopPropagation())}))}),$("#add-hot-point-btn").click(function(e){$("#add-point-mdl").modal()}),$("#select-picture-upload-btn").click(function(e){$("#file-select-picture-adm").click()}),$("#select-picture-lib-btn").click(function(e){I=!1,c(),l(!0)});var D=null;$("#file-select-picture-adm").change(function(e){var n=e.target.files;if(n&&0!=n.length){x=n[0];var i=new Image;t(i,URL.createObjectURL(x),function(){if(i.width>1920||i.height>1080)return $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>设置失败！展示的图片不能大于1920*1080!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),x=null,!1;j="";var e=$("#picture-title-adm").val();e||$("#picture-title-adm").val(x.name);var t=$(".select-picture-img-area");return t.empty(),t.append(i).append("<div class='img-mask'>删除</div>").css("display","block"),null!=D&&D.submit(),!0})}}),$(function(){$("#file-select-picture-adm").fileupload({url:backPath+"/pano/uploadfile",dataType:"json",autoUpload:!1,add:function(e,t){D=t},start:function(e){},done:function(e,t){var n=t.result;if("SUCCESS"==n.returnCode){j=n.cosData.access_url;var i=$("#add-point-mdl .modal-dialog button");i.each(function(){$(this).removeAttr("disabled")})}else alert(n.returnMsg)},progressall:function(e,t){parseInt(t.loaded/t.total*100,10)}})}),$("#add-point-select-file-pane").on("click",".add-point-file-item",function(e){var t=$(e.target);0==t.hasClass("add-point-file-item")&&(t=t.parent(".add-point-file-item")),j=t.attr("data-res-id"),t.css("border-color","#00a3d8"),T&&T.css("border-color",""),T=t}),$("#select-music-upload-btn").click(function(e){$("#file-select-music-adm").click()}),$("#file-select-music-adm").change(function(e){var t=e.target.files;if(t&&0!=t.length){x=t[0];var n=$("#music-title-adm").val();n||$("#music-title-adm").val(x.name);var i=URL.createObjectURL(x),a=$("#point-muisc-player").get(0);a.pause(),a.src=i}}),$(function(){$("#file-select-music-adm").fileupload({url:backPath+"/pano/uploadfile",dataType:"json",autoUpload:!1,add:function(e,t){t.files[0].size>5242880?($("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>音乐文件不能超过5M!</div><div class='foot'><button class='btn3'>确定</button></div></div>"),$("#music-title-adm").val("")):t.submit()},start:function(e){},done:function(e,t){var n=t.result;if("SUCCESS"==n.returnCode){j=n.cosData.access_url;var i=$("#add-point-mdl .modal-dialog button");i.each(function(){$(this).removeAttr("disabled")})}else alert(n.returnMsg)},progressall:function(e,t){parseInt(t.loaded/t.total*100,10)}})}),$("#point-muisc-player-btn").click(function(e){var t=$("#point-muisc-player").get(0);t.paused?(t.play(),$("#point-muisc-player-btn").html("暂停")):(t.pause(),$("#point-muisc-player-btn").html("试听"))}),$("#save-add-point-btn").click(function(e){if(O){if(""===j)return void $("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>请选择需要显示的图片!</div><div class='foot'><button class='btn3'>确定</button></div></div>");T&&(T.css("border-color",""),T="");var n=$(".select-picture-img-area");n.empty();var i=new Image;$(i).attr("crossorigin","Anonymous"),t(i,j),n.append(i),l(!1);var a=$("#music-title-adm").val();if(!a){var o=ResourceMgr.find(j);$("#music-title-adm").val(o[0].name)}}else{var s=!1;S in A&&(s=A[S].doneEvent()),s&&$("#add-point-mdl").modal("hide")}}),$("#cancel-add-point-btn").click(function(e){j="",E="",T&&(T.css("border-color",""),T=""),O?l(!1):$("#add-point-mdl").modal("hide")}),$("#select-material-btn").click(function(){$(".select-icon-container").hide(),$(".select-material-container").show()}),$("#select-sys-btn").click(function(){$(".select-icon-container").show(),$(".select-material-container").hide()}),$("#sys-icon-radio").change(function(e){$(".select-icon-from-lib").hide(),$(".select-icon-container").show()}),$("#lib-icon-radio").change(function(e){$(".select-icon-container").hide(),$(".select-icon-from-lib").show()}),$("#select-icon-lib-btn").click(function(e){I=!0,c(),l(!0)})}();for(var i=0;i<$(".visual-angle-nav>li").length;i++)$(".visual-angle-nav>li").eq(i).click(function(){$(this).css({"border-top":"2px solid #0080FF","border-bottom":"0"}),$(this).siblings().css({"border-top":"0","border-bottom":"2px solid #fff"})});$(".slide-area-line").append("<div class='left-line'></div>"),$(".min-value-slide-body").mousedown(function(){$(".left-line").css({left:$(".slide-area-line").position().left+"px",top:$(".slide-area-line").position().top+"px","margin-left":"6px"}),$(this).mousemove(function(){})}),$(".slide-area-line").append("<div class='right-line'></div>"),$(".max-value-slide-body").mousedown(function(){$(".right-line").css({left:$(".slide-area-line").position().left+$(".slide-area-line").width()+"px",top:$(".slide-area-line").position().top+"px","border-top":"2px solid #ccc"}),$(this).mousemove(function(){})}),$("#add-text-adm").on("focus","#content-introduce-input",function(){$("#save-add-point-btn").removeAttr("disabled")}),$("#add-mark-adm").on("focus","#title-mark-input",function(){$("#save-add-point-btn").removeAttr("disabled")}),$("#hyperlink-addr-adm").on("focus","#hyperlink-url",function(){$("#save-add-point-btn").removeAttr("disabled")}),$("#alertMask").on("click",".btn3",function(){$("#alertMask").css("display","none"),$(".yesOrno").css("display","none")}),$(".select-picture-img-area").mouseover(function(){$(".img-mask").css({display:"block",cursor:"pointer"}),$(".img-mask").click(function(){$("#alertMask").css("display","block").append("<div class='yesOrno'><div class='top'></div><div class='middle'>确定删除?</div><div class='foot'><button class='btn1 btn4'>确定</button><button class='btn2 btn5'>取消</button></div></div>"),$("#alertMask").on("click",".btn4",function(){$(".select-picture-img-area").empty(),$("#picture-title-adm").val(""),$("#alertMask").css("display","none"),$(".yesOrno").css("display","none")}),$("#alertMask").on("click",".btn5",function(){$("#alertMask").css("display","none"),$(".yesOrno").css("display","none")})})}),$(".select-picture-img-area").mouseleave(function(){$(".img-mask").css("display","none")});